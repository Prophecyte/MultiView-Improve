<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multiview - Craft Room</title>
    <!-- OpenGraph / Discord Embed -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Multiview" />
    <meta property="og:url" content="https://multiview.pages.dev/craft.html" />
    <meta property="og:title" content="Multiview ‚Äî Craft Room" />
    <meta property="og:description" content="Collaborative TTRPG workspace ‚Äî boards, maps, timelines, writing, soundscapes & more. Build worlds together in real-time." />
    <meta property="og:image" content="https://multiview.pages.dev/og-craft.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta name="theme-color" content="#d4a824" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Multiview ‚Äî Craft Room" />
    <meta name="twitter:description" content="Collaborative TTRPG workspace ‚Äî boards, maps, timelines, writing, soundscapes & more." />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600&family=Merriweather:ital,wght@0,400;0,700;1,400&family=Lora:ital,wght@0,400;0,700;1,400&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Source+Code+Pro:wght@400;500&family=Roboto+Mono:wght@400;500&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=EB+Garamond:ital,wght@0,400;0,600;1,400&family=Dancing+Script:wght@400;700&family=Permanent+Marker&family=Satisfy&family=Caveat:wght@400;700&family=Oswald:wght@400;600&family=Raleway:ital,wght@0,400;0,600;1,400&family=Poppins:ital,wght@0,400;0,600;1,400&family=Montserrat:wght@400;600;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Spectral:ital,wght@0,400;0,600;1,400&family=Vollkorn:ital,wght@0,400;0,700;1,400&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Alegreya:ital,wght@0,400;0,700;1,400&family=Special+Elite&family=Press+Start+2P&family=VT323&family=UnifrakturMaguntia&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rpg-awesome/0.2.0/css/rpg-awesome.min.css" />
    <link rel="stylesheet" href="craft-styles.css" />
    <style>
    .craft-loading, .craft-auth-needed {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100vh; background: #060606; color: var(--gold, #d4a824); font-family: "Inter", sans-serif;
    }
    .craft-loading .icon { font-size: 48px; animation: bounce 1s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    .craft-auth-needed p { margin: 16px 0; color: var(--text-secondary, #a89880); font-size: 14px; }
    .craft-auth-needed a { color: var(--gold, #d4a824); text-decoration: underline; cursor: pointer; }

    /* ‚ïê‚ïê‚ïê Modal overlay + modal (identical to video room styles.css) ‚ïê‚ïê‚ïê */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.15s; backdrop-filter: blur(4px); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal { background: var(--bg-medium, #111); border: 1px solid var(--border-color, #252015); border-radius: var(--radius-lg, 10px); padding: 24px; max-width: 400px; width: 90%; position: relative; animation: slideUp 0.2s; box-shadow: var(--shadow-lg, 0 8px 30px rgba(0,0,0,0.6)); z-index: 1001; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
    .modal-close { position: absolute; top: 12px; right: 12px; background: none; border: none; color: var(--text-muted, #605545); cursor: pointer; padding: 4px; font-size: 18px; line-height: 1; transition: color 0.15s; }
    .modal-close:hover { color: var(--text-primary, #f5ede0); }
    .modal h2 { font-family: 'Cinzel', serif; font-size: 18px; color: var(--gold, #d4a824); margin-bottom: 8px; }
    .modal p { color: var(--text-secondary, #a89880); font-size: 14px; margin-bottom: 20px; }
    .modal-input-group { margin-bottom: 16px; }
    .modal-input-group label { display: block; font-family: 'Cinzel', serif; font-size: 11px; color: var(--text-secondary, #a89880); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.1em; }
    .modal-input-group input { width: 100%; padding: 10px 12px; background: var(--bg-dark, #0a0a0a); border: 1px solid var(--border-color, #252015); border-radius: var(--radius-md, 6px); color: var(--text-primary, #f5ede0); font-size: 14px; outline: none; box-sizing: border-box; font-family: inherit; }
    .modal-input-group input:focus { border-color: var(--gold, #d4a824); box-shadow: 0 0 0 3px var(--gold-subtle, rgba(212,168,36,0.1)); }
    .modal-input-group input:disabled { opacity: 0.5; }
    .modal .btn, .modal-overlay .btn { padding: 10px 20px; border: none; border-radius: var(--radius-md, 6px); font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.15s; }
    .modal .btn.primary, .modal-overlay .btn.primary { background: var(--gold, #d4a824); color: var(--bg-darkest, #060606); }
    .modal .btn.primary:hover { filter: brightness(1.1); }
    .modal .btn.danger { background: rgba(239,68,68,0.15); color: #ef4444; border: 1px solid rgba(239,68,68,0.2); }
    .settings-modal { max-width: 480px; }
    .settings-tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color, #252015); padding-bottom: 12px; }
    .settings-tab { padding: 8px 16px; background: none; border: none; color: var(--text-secondary, #a89880); font-family: 'Cinzel', serif; font-size: 12px; cursor: pointer; border-radius: var(--radius-sm, 4px); transition: all 0.15s; }
    .settings-tab:hover { background: var(--bg-hover, #2a2a2a); }
    .settings-tab.active { background: var(--gold-subtle, rgba(212,168,36,0.1)); color: var(--gold, #d4a824); }
    .settings-content { padding-top: 4px; }
    .section-description { color: var(--text-secondary, #a89880); font-size: 13px; margin-bottom: 16px; }
    .error-message, .success-message { padding: 10px 14px; border-radius: var(--radius-md, 6px); font-size: 13px; margin-bottom: 12px; }
    .error-message { background: rgba(239,68,68,0.12); color: #ef4444; border: 1px solid rgba(239,68,68,0.2); }
    .success-message { background: rgba(34,197,94,0.12); color: #22c55e; border: 1px solid rgba(34,197,94,0.2); }
    .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 8px; }
    .theme-option { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 12px 8px; background: var(--bg-dark, #0a0a0a); border: 2px solid var(--border-color, #252015); border-radius: var(--radius-md, 6px); cursor: pointer; transition: all 0.15s; }
    .theme-option:hover { border-color: var(--border-light, #352a1a); background: var(--bg-light, #181818); }
    .theme-option.active { border-color: var(--gold, #d4a824); background: var(--gold-subtle, rgba(212,168,36,0.1)); }
    .theme-swatch { width: 32px; height: 32px; border-radius: 50%; box-shadow: var(--shadow-sm, 0 1px 3px rgba(0,0,0,0.4)); }
    .theme-name { font-size: 11px; color: var(--text-secondary, #a89880); text-transform: capitalize; }
    .theme-option.active .theme-name { color: var(--gold, #d4a824); font-weight: 600; }
    .share-modal { max-width: 450px; }
    .share-link-box { display: flex; gap: 8px; }
    .share-link-box input { flex: 1; padding: 10px 12px; background: var(--bg-dark, #0a0a0a); border: 1px solid var(--border-color, #252015); border-radius: var(--radius-md, 6px); color: var(--text-primary, #f5ede0); font-size: 13px; outline: none; }
    .guest-modal { max-width: 380px; }
    .danger-zone { margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(239,68,68,0.3); }
    .danger-zone h3 { font-family: 'Cinzel', serif; font-size: 13px; color: #ef4444; margin-bottom: 12px; }
    .danger-zone p { font-size: 13px; color: var(--text-muted, #605545); margin-bottom: 12px; }
    .perm-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 12px; background: var(--bg-light, #181818); border: 1px solid var(--border-color, #252015); border-radius: var(--radius-md, 6px); margin-bottom: 8px; }
    .perm-info { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
    .perm-name { color: var(--text-primary, #f5ede0); font-size: 13px; font-weight: 500; }
    .perm-status { font-size: 11px; }
    .perm-status.online { color: #22c55e; }
    .perm-status.offline { color: var(--text-muted, #605545); }
    .perm-controls { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .perm-select { padding: 5px 8px; background: var(--bg-dark, #0a0a0a); border: 1px solid var(--border-color, #252015); border-radius: 6px; color: #ccc; font-size: 12px; font-family: inherit; cursor: pointer; }
    .perm-select option { background: #111; color: #eee; }
    .perm-cb { display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 11px; color: var(--text-secondary, #a89880); white-space: nowrap; }
    .perm-cb input[type="checkbox"] { accent-color: var(--gold, #d4a824); width: 14px; height: 14px; cursor: pointer; }
    .craft-user-menu { position: relative; }
    .craft-user-btn { display: flex; align-items: center; gap: 8px; padding: 4px 10px; background: rgba(255,255,255,0.04); border: 1px solid var(--border-color, #252015); border-radius: 8px; color: var(--text-secondary, #a89880); cursor: pointer; font-family: inherit; font-size: 13px; }
    .craft-user-btn:hover { border-color: var(--gold-dark, #a07810); color: var(--text-primary, #f5ede0); }
    .craft-user-btn .avatar { width: 24px; height: 24px; border-radius: 50%; background: var(--gold, #d4a824); color: var(--bg-darkest, #060606); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; }
    .craft-user-btn .guest-tag { font-size: 10px; color: var(--text-muted, #605545); background: rgba(255,255,255,0.08); padding: 1px 5px; border-radius: 6px; }
    .craft-user-dropdown { position: absolute; top: 100%; right: 0; margin-top: 6px; background: var(--bg-medium, #111); border: 1px solid var(--border-color, #252015); border-radius: 12px; min-width: 200px; z-index: 1000; box-shadow: var(--shadow-lg, 0 8px 30px rgba(0,0,0,0.6)); overflow: hidden; }
    .craft-user-dropdown .dd-header { padding: 12px 14px; border-bottom: 1px solid var(--border-color, #252015); }
    .craft-user-dropdown .dd-header .name { color: var(--text-primary, #f5ede0); font-weight: 500; font-size: 13px; }
    .craft-user-dropdown .dd-header .email { color: var(--text-muted, #605545); font-size: 11px; margin-top: 2px; }
    .craft-user-dropdown .dd-item { display: flex; align-items: center; gap: 8px; width: 100%; padding: 10px 14px; background: none; border: none; color: var(--text-secondary, #a89880); cursor: pointer; font-size: 13px; font-family: inherit; text-align: left; }
    .craft-user-dropdown .dd-item:hover { background: var(--bg-hover, #2a2a2a); }
    .craft-user-dropdown .dd-item.danger { color: #ef4444; }
    .craft-user-dropdown .dd-item.primary { color: var(--gold, #d4a824); }
    .craft-user-dropdown .dd-divider { height: 1px; background: var(--border-color, #252015); margin: 2px 0; }
    /* ‚ïê‚ïê‚ïê Settings Logout Tab (matches video room) ‚ïê‚ïê‚ïê */
    .settings-tab.logout { margin-left: auto; color: #ef4444; }
    .settings-tab.logout:hover { background: rgba(239,68,68,0.1); }
    .settings-section { padding: 4px 0; }

    /* ‚ïê‚ïê‚ïê Guest Modal Divider (matches video room) ‚ïê‚ïê‚ïê */
    .guest-modal-icon { font-size: 64px; text-align: center; margin-bottom: 16px; }
    .guest-modal-divider { display: flex; align-items: center; gap: 12px; margin: 16px 0; color: var(--text-muted, #605545); font-size: 12px; }
    .guest-modal-divider::before, .guest-modal-divider::after { content: ''; flex: 1; height: 1px; background: var(--border-color, #252015); }

    /* ‚ïê‚ïê‚ïê Connected Users Section (matches video room) ‚ïê‚ïê‚ïê */
    .craft-connected-section { background: var(--bg-medium, #111); border: 1px solid var(--border-color, #252015); border-radius: 6px; flex-shrink: 0; margin: 0 8px 4px; }
    .craft-connected-section .connected-header { display: flex; align-items: center; justify-content: space-between; padding: 6px 12px; border-bottom: 1px solid var(--border-color, #252015); background: var(--bg-light, #181818); border-radius: 6px 6px 0 0; }
    .craft-connected-section .connected-header h4 { font-family: 'Cinzel', serif; font-size: 11px; color: var(--gold, #d4a824); text-transform: uppercase; letter-spacing: 0.08em; display: flex; align-items: center; gap: 6px; margin: 0; white-space: nowrap; }
    .craft-connected-section .connected-header h4 svg { stroke: currentColor; fill: none; }
    .craft-connected-section .online-count { font-size: 11px; color: var(--text-muted, #605545); white-space: nowrap; }
    .craft-connected-section .online-count .count { color: #22c55e; font-weight: 600; }
    .craft-connected-section .users-list { display: flex; flex-wrap: wrap; gap: 5px; padding: 8px 10px; min-height: 28px; }
    .craft-connected-section .no-users { padding: 6px 12px; text-align: center; color: var(--text-muted, #605545); font-size: 11px; font-style: italic; width: 100%; }
    .craft-connected-section .user-badge { display: flex; align-items: center; gap: 5px; padding: 3px 10px; background: rgba(20,20,20,0.8); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; font-size: 11px; cursor: pointer; transition: all 0.2s ease; }
    .craft-connected-section .user-badge:hover { background: rgba(40,40,40,0.9); border-color: rgba(255,255,255,0.15); }
    .craft-connected-section .user-badge.offline { opacity: 0.45; }
    .craft-connected-section .user-badge.is-you { border-color: rgba(212,168,36,0.4); background: rgba(212,168,36,0.1); }
    .craft-connected-section .user-badge.is-owner { border-color: var(--gold, #d4a824); background: linear-gradient(135deg, rgba(212,168,36,0.15) 0%, rgba(212,168,36,0.06) 100%); }
    .craft-connected-section .user-badge.is-owner.is-you { box-shadow: 0 0 8px rgba(212,168,36,0.12); }
    .craft-connected-section .owner-crown { font-size: 11px; margin-right: -2px; filter: drop-shadow(0 0 2px rgba(255,215,0,0.5)); }
    .craft-connected-section .status-indicator { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .craft-connected-section .status-indicator.online { background: #22c55e; box-shadow: 0 0 4px rgba(34,197,94,0.4); }
    .craft-connected-section .status-indicator.offline { background: var(--text-muted, #605545); }
    .craft-connected-section .badge-name { color: var(--text-primary, #f5ede0); font-weight: 500; }
    .craft-connected-section .user-badge.is-you .badge-name { color: var(--gold, #d4a824); }
    .craft-connected-section .you-tag { font-size: 9px; color: var(--text-muted, #605545); opacity: 0.7; }
    .craft-connected-section .guest-tag-badge { font-size: 9px; color: var(--text-muted, #605545); margin-left: 1px; opacity: 0.6; }
    .craft-connected-section .role-chip { font-size: 9px; opacity: 0.5; margin-left: 1px; }
    .craft-connected-section .view-tag { font-size: 8px; color: var(--text-muted, #605545); background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); border-radius: 3px; padding: 1px 5px; margin-left: 2px; letter-spacing: 0.02em; }
    .craft-connected-section .sync-pill { font-size: 10px; padding: 1px 7px; border-radius: 10px; white-space: nowrap; }
    .craft-connected-section .sync-pill.synced { color: #22c55e; background: rgba(34,197,94,0.08); }
    .craft-connected-section .sync-pill.syncing { color: var(--gold, #d4a824); background: rgba(212,168,36,0.08); }
    .craft-connected-section .sync-pill.error { color: #ef4444; background: rgba(239,68,68,0.08); }

    .craft-connected-section .user-badge[style*='background'] { border-color: rgba(255,255,255,0.15); }
    .craft-connected-section .user-badge[style*='background'] .badge-name { color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .craft-connected-section .user-badge[style*='background'] .you-tag,
    .craft-connected-section .user-badge[style*='background'] .guest-tag-badge,
    .craft-connected-section .user-badge[style*='background'] .role-chip { color: rgba(255,255,255,0.7); }
    .color-picker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 20px; justify-items: center; }
    .color-option { width: 48px; height: 48px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: all 0.15s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .color-option:hover { transform: scale(1.15); box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
    .color-option.selected { border-color: white; box-shadow: 0 0 0 2px var(--gold, #d4a824), 0 4px 12px rgba(0,0,0,0.4); }

    /* ‚ïê‚ïê‚ïê Context Menu ‚ïê‚ïê‚ïê */
    .context-menu { background: var(--bg-medium, #111); border: 1px solid var(--border-color, #252015); border-radius: var(--radius-md, 6px); box-shadow: 0 8px 32px rgba(0,0,0,0.5); min-width: 160px; z-index: 10000; overflow: hidden; animation: fadeIn 0.1s; }
    .context-menu-item { display: flex; align-items: center; gap: 8px; width: 100%; padding: 10px 14px; background: none; border: none; color: var(--text-primary, #f5ede0); font-size: 13px; cursor: pointer; transition: background 0.15s; font-family: inherit; text-align: left; }
    .context-menu-item:hover { background: var(--bg-hover, #2a2a2a); }
    .context-menu-item.danger { color: #ef4444; }
    .context-menu-item.danger:hover { background: rgba(220,53,69,0.1); }
  </style>
  </head>
  <body>
    <div class="dashboard">
      <!-- Header -->
      <header class="dashboard-header">
        <div class="header-left">
          <button class="icon-btn" id="toggleSidebarBtn">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M3 12h18M3 6h18M3 18h18" />
            </svg>
          </button>
          <button class="icon-btn" id="craftHomeBtn" onclick="window.location.href='/'">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
          </button>
          <div class="room-title-container">
            <input
              type="text"
              class="room-title-input"
              id="roomTitle"
              value="Craft Room"
            />
          </div>
        </div>

        <div class="header-center">
          <div class="view-toggle">
            <button
              class="view-toggle-btn active"
              id="boardViewBtn"
              data-view="board"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="3" width="7" height="7" />
                <rect x="14" y="3" width="7" height="7" />
                <rect x="14" y="14" width="7" height="7" />
                <rect x="3" y="14" width="7" height="7" />
              </svg>
              <span>Board</span>
            </button>
            <button class="view-toggle-btn" id="mapViewBtn" data-view="map">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6" />
                <line x1="8" y1="2" x2="8" y2="18" />
                <line x1="16" y1="6" x2="16" y2="22" />
              </svg>
              <span>Map</span>
            </button>
            <button class="view-toggle-btn" id="writeViewBtn" data-view="write">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M12 19l7-7 3 3-7 7-3-3z" />
                <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z" />
              </svg>
              <span>Write</span>
            </button>
            <button class="view-toggle-btn" id="timelineViewBtn" data-view="timeline">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="2" x2="12" y2="22" />
                <circle cx="12" cy="6" r="2.5" fill="currentColor" stroke="none" />
                <line x1="14.5" y1="6" x2="20" y2="6" />
                <circle cx="12" cy="12" r="2.5" fill="currentColor" stroke="none" />
                <line x1="4" y1="12" x2="9.5" y2="12" />
                <circle cx="12" cy="18" r="2.5" fill="currentColor" stroke="none" />
                <line x1="14.5" y1="18" x2="20" y2="18" />
              </svg>
              <span>Timeline</span>
            </button>
            <button class="view-toggle-btn" id="combatViewBtn" data-view="combat">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.5 17.5L3 6V3h3l11.5 11.5"/><path d="M13 7.5l4-4 4 4-4 4"/><path d="M7.5 13l-4 4 4 4 4-4"/>
              </svg>
              <span>Combat</span>
            </button>
            <button class="view-toggle-btn" id="factionViewBtn" data-view="factions">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/>
              </svg>
              <span>Connections</span>
            </button>
            <button class="view-toggle-btn" id="mindmapViewBtn" data-view="mindmap">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/><circle cx="4" cy="6" r="2"/><circle cx="20" cy="6" r="2"/><circle cx="4" cy="18" r="2"/><circle cx="20" cy="18" r="2"/>
                <line x1="9.5" y1="10.5" x2="5.5" y2="7.5"/><line x1="14.5" y1="10.5" x2="18.5" y2="7.5"/><line x1="9.5" y1="13.5" x2="5.5" y2="16.5"/><line x1="14.5" y1="13.5" x2="18.5" y2="16.5"/>
              </svg>
              <span>Mind Map</span>
            </button>
            <button class="view-toggle-btn" id="soundboardViewBtn" data-view="soundboard">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
              </svg>
              <span>Soundscape</span>
            </button>
          </div>
        </div>

        <div class="header-right">
          <button class="icon-btn multiview-btn" id="multiviewBtn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="7" height="7" rx="1.5"/>
              <rect x="14" y="3" width="7" height="7" rx="1.5"/>
              <rect x="3" y="14" width="7" height="7" rx="1.5"/>
              <rect x="14" y="14" width="7" height="7" rx="1.5"/>
            </svg>
          </button>
          <button class="icon-btn search-nav-btn" id="searchNavBtn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          </button>
          <button class="dice-roller-btn" id="diceRollerBtn">
            <svg class="dice-icon" viewBox="0 0 24 24" width="18" height="18">
              <rect
                x="3"
                y="3"
                width="18"
                height="18"
                rx="2"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              />
              <circle cx="8" cy="8" r="1.5" fill="currentColor" />
              <circle cx="16" cy="8" r="1.5" fill="currentColor" />
              <circle cx="8" cy="16" r="1.5" fill="currentColor" />
              <circle cx="16" cy="16" r="1.5" fill="currentColor" />
              <circle cx="12" cy="12" r="1.5" fill="currentColor" />
            </svg>
            <span>Roll</span>
          </button>
          <button class="icon-btn settings-btn" id="settingsBtn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
            </svg>
          </button>
          <div id="craftShareBtn" style="display:none"></div>
          <div id="craftUserMenu"></div>
          <button class="icon-btn" id="togglePanelBtn">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="3" width="18" height="18" rx="2" />
              <path d="M15 3v18" />
            </svg>
          </button>
        </div>
      </header>

      <!-- Custom Popup Modal -->
      <div class="popup-overlay hidden" id="popupModal">
        <div class="popup-modal">
          <div class="popup-header">
            <h3 id="popupTitle">Input</h3>
            <button class="icon-btn popup-close" id="closePopup">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="popup-body" id="popupBody">
            <input
              type="text"
              class="popup-input"
              id="popupInput"
              placeholder=""
            />
          </div>
          <div class="popup-actions">
            <button class="btn secondary" id="popupCancel">Cancel</button>
            <button class="btn primary" id="popupConfirm">Confirm</button>
          </div>
        </div>
      </div>

      <!-- Dice Roller Modal -->
      <div class="popup-overlay hidden" id="diceModal">
        <div class="popup-modal dice-modal">
          <div class="popup-header">
            <h3>Dice Roller</h3>
            <button class="icon-btn popup-close" id="closeDiceModal">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="dice-options">
            <button class="dice-btn" data-dice="d4">
              <svg class="dice-svg" viewBox="0 0 32 32">
                <polygon
                  points="16,4 28,26 4,26"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <text
                  x="16"
                  y="20"
                  text-anchor="middle"
                  font-size="10"
                  fill="currentColor"
                >
                  4
                </text>
              </svg>
              <span>d4</span>
            </button>
            <button class="dice-btn" data-dice="d6">
              <svg class="dice-svg" viewBox="0 0 32 32">
                <rect
                  x="4"
                  y="4"
                  width="24"
                  height="24"
                  rx="3"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <circle cx="10" cy="10" r="2" fill="currentColor" />
                <circle cx="22" cy="10" r="2" fill="currentColor" />
                <circle cx="16" cy="16" r="2" fill="currentColor" />
                <circle cx="10" cy="22" r="2" fill="currentColor" />
                <circle cx="22" cy="22" r="2" fill="currentColor" />
              </svg>
              <span>d6</span>
            </button>
            <button class="dice-btn" data-dice="d8">
              <svg class="dice-svg" viewBox="0 0 32 32">
                <polygon
                  points="16,2 30,16 16,30 2,16"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <text
                  x="16"
                  y="20"
                  text-anchor="middle"
                  font-size="10"
                  fill="currentColor"
                >
                  8
                </text>
              </svg>
              <span>d8</span>
            </button>
            <button class="dice-btn" data-dice="d10">
              <svg class="dice-svg" viewBox="0 0 32 32">
                <polygon
                  points="16,2 28,12 24,28 8,28 4,12"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <text
                  x="16"
                  y="20"
                  text-anchor="middle"
                  font-size="10"
                  fill="currentColor"
                >
                  10
                </text>
              </svg>
              <span>d10</span>
            </button>
            <button class="dice-btn" data-dice="d12">
              <svg class="dice-svg" viewBox="0 0 32 32">
                <polygon
                  points="16,2 26,7 30,17 24,27 8,27 2,17 6,7"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <text
                  x="16"
                  y="20"
                  text-anchor="middle"
                  font-size="9"
                  fill="currentColor"
                >
                  12
                </text>
              </svg>
              <span>d12</span>
            </button>
            <button class="dice-btn" data-dice="d20">
              <svg class="dice-svg" viewBox="0 0 32 32">
                <polygon
                  points="16,2 28,10 28,22 16,30 4,22 4,10"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <text
                  x="16"
                  y="20"
                  text-anchor="middle"
                  font-size="9"
                  fill="currentColor"
                >
                  20
                </text>
              </svg>
              <span>d20</span>
            </button>
            <button class="dice-btn" data-dice="d100">
              <svg class="dice-svg" viewBox="0 0 32 32">
                <circle
                  cx="11"
                  cy="16"
                  r="9"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <circle
                  cx="21"
                  cy="16"
                  r="9"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
              <span>d100</span>
            </button>
          </div>
          <div class="dice-custom">
            <input
              type="text"
              id="customDice"
              placeholder="Custom (e.g., 2d6+3)"
            />
            <button class="btn primary" id="rollCustomBtn">Roll</button>
          </div>
          <div class="dice-result" id="diceResult">
            <span class="result-label">Result:</span>
            <span class="result-value" id="diceResultValue">‚Äî</span>
          </div>
          <div class="dice-actions">
            <button class="btn primary" id="insertDiceResult" disabled>
              Insert Result
            </button>
          </div>
          <div class="dice-history" id="diceHistory"></div>
        </div>
      </div>

      <!-- Image Upload Modal -->
      <div class="popup-overlay hidden" id="imageUploadModal">
        <div class="popup-modal">
          <div class="popup-header">
            <h3>Insert Image</h3>
            <button class="icon-btn popup-close" id="closeImageModal">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="popup-body">
            <div class="upload-tabs">
              <button class="upload-tab active" data-tab="file">
                Upload File
              </button>
              <button class="upload-tab" data-tab="url">From URL</button>
            </div>
            <div class="upload-content">
              <div class="upload-tab-content active" id="fileTab">
                <div class="file-drop-zone" id="fileDropZone">
                  <span>üìÅ</span>
                  <p>Drop image here or click to browse</p>
                  <input
                    type="file"
                    id="imageFileInput"
                    accept="image/*"
                    class="hidden"
                  />
                </div>
                <div class="file-preview hidden" id="filePreview">
                  <img id="previewImg" src="" alt="Preview" />
                  <button class="btn secondary sm" id="clearPreview">
                    Clear
                  </button>
                </div>
              </div>
              <div class="upload-tab-content hidden" id="urlTab">
                <input
                  type="text"
                  class="popup-input"
                  id="imageUrlInput"
                  placeholder="https://example.com/image.jpg"
                />
              </div>
            </div>
          </div>
          <div class="popup-actions">
            <button class="btn secondary" id="cancelImageUpload">Cancel</button>
            <button class="btn primary" id="confirmImageUpload">Insert</button>
          </div>
        </div>
      </div>

      <!-- Columns Modal (Write View) -->
      <div class="popup-overlay hidden" id="columnsModal">
        <div class="popup-modal">
          <div class="popup-header">
            <h3>Insert Columns</h3>
            <button class="icon-btn popup-close" id="closeColumnsModal">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="popup-body">
            <label class="popup-label">Choose Layout</label>
            <div class="column-layouts">
              <button
                class="column-layout-btn"
                data-layout="50-50"
               
              >
                <div class="layout-preview"><span></span><span></span></div>
                <span>50/50</span>
              </button>
              <button
                class="column-layout-btn"
                data-layout="33-33-33"
               
              >
                <div class="layout-preview">
                  <span></span><span></span><span></span>
                </div>
                <span>33/33/33</span>
              </button>
              <button
                class="column-layout-btn"
                data-layout="25-50-25"
               
              >
                <div class="layout-preview">
                  <span style="flex: 1"></span><span style="flex: 2"></span
                  ><span style="flex: 1"></span>
                </div>
                <span>25/50/25</span>
              </button>
              <button
                class="column-layout-btn"
                data-layout="30-70"
               
              >
                <div class="layout-preview">
                  <span style="flex: 3"></span><span style="flex: 7"></span>
                </div>
                <span>30/70</span>
              </button>
              <button
                class="column-layout-btn"
                data-layout="70-30"
               
              >
                <div class="layout-preview">
                  <span style="flex: 7"></span><span style="flex: 3"></span>
                </div>
                <span>70/30</span>
              </button>
              <button
                class="column-layout-btn"
                data-layout="25-25-25-25"
               
              >
                <div class="layout-preview">
                  <span></span><span></span><span></span><span></span>
                </div>
                <span>25√ó4</span>
              </button>
            </div>
          </div>
          <div class="popup-actions">
            <button class="btn secondary" id="cancelColumns">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Map Upload Modal -->
      <div class="popup-overlay hidden" id="mapUploadModal">
        <div class="popup-modal">
          <div class="popup-header">
            <h3>Upload Map</h3>
            <button class="icon-btn popup-close" id="closeMapUploadModal">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="popup-body">
            <div class="file-drop-zone" id="mapDropZone">
              <span>üó∫Ô∏è</span>
              <p>Drop map image here or click to browse</p>
              <input
                type="file"
                id="mapFileInput"
                accept="image/*"
                class="hidden"
              />
            </div>
            <div class="file-preview hidden" id="mapFilePreview">
              <img id="mapPreviewImg" src="" alt="Map Preview" />
              <button class="btn secondary sm" id="clearMapPreview">
                Clear
              </button>
            </div>
          </div>
          <div class="popup-actions">
            <button class="btn secondary" id="cancelMapUpload">Cancel</button>
            <button class="btn primary" id="confirmMapUpload">Set Map</button>
          </div>
        </div>
      </div>

      <!-- Pin Editor Modal -->
      <div class="popup-overlay hidden" id="pinEditorModal">
        <div class="popup-modal">
          <div class="popup-header">
            <h3 id="pinEditorTitle">Edit Pin</h3>
            <button class="icon-btn popup-close" id="closePinEditor">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="popup-body">
            <label class="popup-label">Name</label>
            <input
              type="text"
              class="popup-input"
              id="pinName"
              placeholder="Location name..."
            />

            <label class="popup-label">Description</label>
            <textarea
              class="popup-textarea"
              id="pinDescription"
              placeholder="Description... Use [[Card Name]] to link to cards"
            ></textarea>

            <label class="popup-label">Shape</label>
            <div class="pin-shape-options" id="pinShapeOptions">
              <button
                class="pin-shape-btn active"
                data-shape="circle"
               
              >
                <svg width="20" height="20" viewBox="0 0 20 20">
                  <circle cx="10" cy="10" r="8" fill="currentColor" />
                </svg>
              </button>
              <button
                class="pin-shape-btn"
                data-shape="diamond"
               
              >
                <svg width="20" height="20" viewBox="0 0 20 20">
                  <rect
                    x="4"
                    y="4"
                    width="12"
                    height="12"
                    fill="currentColor"
                    transform="rotate(45 10 10)"
                  />
                </svg>
              </button>
              <button class="pin-shape-btn" data-shape="pin">
                <svg width="20" height="20" viewBox="0 0 20 20">
                  <path
                    d="M10 2C6.5 2 4 4.5 4 7.5c0 4 6 10.5 6 10.5s6-6.5 6-10.5C16 4.5 13.5 2 10 2z"
                    fill="currentColor"
                  />
                </svg>
              </button>
              <button class="pin-shape-btn" data-shape="square">
                <svg width="20" height="20" viewBox="0 0 20 20">
                  <rect
                    x="3"
                    y="3"
                    width="14"
                    height="14"
                    fill="currentColor"
                  />
                </svg>
              </button>
              <button class="pin-shape-btn" data-shape="star">
                <svg width="20" height="20" viewBox="0 0 20 20">
                  <path
                    d="M10 2l2.5 5 5.5.8-4 3.9 1 5.5-5-2.6-5 2.6 1-5.5-4-3.9 5.5-.8z"
                    fill="currentColor"
                  />
                </svg>
              </button>
              <button
                class="pin-shape-btn"
                data-shape="triangle"
               
              >
                <svg width="20" height="20" viewBox="0 0 20 20">
                  <path d="M10 3L18 17H2z" fill="currentColor" />
                </svg>
              </button>
            </div>

            <label class="popup-label">Color</label>
            <div class="pin-color-options" id="pinColorOptions">
              <button
                class="pin-color-btn active"
                data-color="#ef4444"
                style="background: #ef4444"
              ></button>
              <button
                class="pin-color-btn"
                data-color="#f97316"
                style="background: #f97316"
              ></button>
              <button
                class="pin-color-btn"
                data-color="#eab308"
                style="background: #eab308"
              ></button>
              <button
                class="pin-color-btn"
                data-color="#22c55e"
                style="background: #22c55e"
              ></button>
              <button
                class="pin-color-btn"
                data-color="#14b8a6"
                style="background: #14b8a6"
              ></button>
              <button
                class="pin-color-btn"
                data-color="#3b82f6"
                style="background: #3b82f6"
              ></button>
              <button
                class="pin-color-btn"
                data-color="#8b5cf6"
                style="background: #8b5cf6"
              ></button>
              <button
                class="pin-color-btn"
                data-color="#ec4899"
                style="background: #ec4899"
              ></button>
              <button
                class="pin-color-btn"
                data-color="#ffffff"
                style="background: #ffffff"
              ></button>
              <button
                class="pin-color-btn"
                data-color="#64748b"
                style="background: #64748b"
              ></button>
            </div>

            <label class="popup-label">Icon <span style="opacity:0.5;font-size:11px">(optional, displayed inside pin)</span></label>
            <div class="pin-icon-options" id="pinIconOptions">
              <button class="pin-icon-btn active" data-icon="">‚úï</button>
              <button class="pin-icon-btn" data-icon="ra-castle-emblem"><i class="ra ra-castle-emblem"></i></button>
              <button class="pin-icon-btn" data-icon="ra-tower"><i class="ra ra-tower"></i></button>
              <button class="pin-icon-btn" data-icon="ra-capitol"><i class="ra ra-capitol"></i></button>
              <button class="pin-icon-btn" data-icon="ra-campfire"><i class="ra ra-campfire"></i></button>
              <button class="pin-icon-btn" data-icon="ra-beer"><i class="ra ra-beer"></i></button>
              <button class="pin-icon-btn" data-icon="ra-bridge"><i class="ra ra-bridge"></i></button>
              <button class="pin-icon-btn" data-icon="ra-mountains"><i class="ra ra-mountains"></i></button>
              <button class="pin-icon-btn" data-icon="ra-pine-tree"><i class="ra ra-pine-tree"></i></button>
              <button class="pin-icon-btn" data-icon="ra-ocean-emblem"><i class="ra ra-ocean-emblem"></i></button>
              <button class="pin-icon-btn" data-icon="ra-skull"><i class="ra ra-skull"></i></button>
              <button class="pin-icon-btn" data-icon="ra-dragon"><i class="ra ra-dragon"></i></button>
              <button class="pin-icon-btn" data-icon="ra-sword"><i class="ra ra-sword"></i></button>
              <button class="pin-icon-btn" data-icon="ra-shield"><i class="ra ra-shield"></i></button>
              <button class="pin-icon-btn" data-icon="ra-key"><i class="ra ra-key"></i></button>
              <button class="pin-icon-btn" data-icon="ra-gem"><i class="ra ra-gem"></i></button>
              <button class="pin-icon-btn" data-icon="ra-scroll-unfurled"><i class="ra ra-scroll-unfurled"></i></button>
              <button class="pin-icon-btn" data-icon="ra-crystal-ball"><i class="ra ra-crystal-ball"></i></button>
              <button class="pin-icon-btn" data-icon="ra-hospital-cross"><i class="ra ra-hospital-cross"></i></button>
              <button class="pin-icon-btn" data-icon="ra-tombstone"><i class="ra ra-tombstone"></i></button>
              <button class="pin-icon-btn" data-icon="ra-anchor"><i class="ra ra-anchor"></i></button>
              <button class="pin-icon-btn" data-icon="ra-book"><i class="ra ra-book"></i></button>
              <button class="pin-icon-btn" data-icon="ra-wooden-sign"><i class="ra ra-wooden-sign"></i></button>
              <button class="pin-icon-btn" data-icon="ra-mine-wagon"><i class="ra ra-mine-wagon"></i></button>
              <button class="pin-icon-btn" data-icon="ra-crown"><i class="ra ra-crown"></i></button>
            </div>

            <label class="popup-label">Icon Color</label>
            <div class="pin-icon-color-row" id="pinIconColorRow">
              <input type="color" class="pin-icon-color-picker" id="pinIconColorPicker" value="#ffffff" />
              <span class="pin-icon-color-label" id="pinIconColorLabel">#ffffff</span>
              <button class="btn secondary sm" onclick="document.getElementById('pinIconColorPicker').value='#ffffff';document.getElementById('pinIconColorLabel').textContent='#ffffff';">Reset</button>
            </div>

            <label class="popup-label">Tags</label>
            <input
              type="text"
              class="popup-input"
              id="pinTags"
              placeholder="tavern, safe, city..."
            />

            <label class="popup-label">Associations</label>
            <div class="search-input-wrapper">
              <input
                type="text"
                class="popup-input"
                id="pinAssociationSearch"
                placeholder="Search cards, pins, chapters..."
                autocomplete="off"
              />
              <div
                class="search-results hidden"
                id="pinAssociationSearchResults"
              ></div>
            </div>
            <div class="associations-list" id="pinAssociationsList"></div>
          </div>
          <div class="popup-actions">
            <button class="btn danger" id="deletePinBtn">Delete</button>
            <button class="btn secondary" id="cancelPinEdit">Cancel</button>
            <button class="btn primary" id="savePinEdit">Save</button>
          </div>
        </div>
      </div>

      <!-- Map Editor Modal -->
      <div class="popup-overlay hidden" id="mapEditorModal">
        <div class="popup-modal">
          <div class="popup-header">
            <h3 id="mapEditorTitle">Edit Map</h3>
            <button class="icon-btn popup-close" id="closeMapEditor">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="popup-body">
            <label class="popup-label">Map Name</label>
            <input
              type="text"
              class="popup-input"
              id="mapEditorName"
              placeholder="World Map..."
            />

            <label class="popup-label">Map Image</label>
            <div class="map-image-preview" id="mapEditorPreview">
              <img id="mapEditorPreviewImg" src="" alt="Map preview" />
              <button class="btn secondary sm" id="changeMapImageBtn">
                Change Image
              </button>
            </div>
            <input
              type="file"
              id="mapEditorFileInput"
              accept="image/*"
              style="display: none"
            />

            <label class="popup-label">Scale Settings</label>
            <div class="scale-settings">
              <div class="scale-row">
                <input
                  type="number"
                  class="popup-input sm"
                  id="mapScalePixels"
                  value="100"
                  min="1"
                />
                <span>pixels =</span>
                <input
                  type="number"
                  class="popup-input sm"
                  id="mapScaleDistance"
                  value="1"
                  min="0.01"
                  step="0.01"
                />
                <select class="popup-select sm" id="mapScaleUnit">
                  <option value="miles">miles</option>
                  <option value="km">km</option>
                  <option value="feet">feet</option>
                  <option value="meters">meters</option>
                  <option value="leagues">leagues</option>
                  <option value="days">days travel</option>
                </select>
              </div>
            </div>
          </div>
          <div class="popup-actions">
            <button class="btn danger" id="deleteMapBtn">Delete Map</button>
            <button class="btn secondary" id="cancelMapEdit">Cancel</button>
            <button class="btn primary" id="saveMapEdit">Save</button>
          </div>
        </div>
      </div>

      <!-- Destination Editor Modal -->
      <div class="popup-overlay hidden" id="destEditorModal">
        <div class="popup-modal sm">
          <div class="popup-header">
            <h3 id="destEditorTitle">Edit Destination</h3>
            <button class="icon-btn popup-close" onclick="closeDestEditorModal()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12" /></svg>
            </button>
          </div>
          <div class="popup-body">
            <label class="popup-label">Name</label>
            <input type="text" class="popup-input" id="destName" placeholder="Destination name..." />

            <label class="popup-label">Color</label>
            <div class="pin-color-options" id="destColorOptions">
              <button class="pin-color-btn active" data-color="#f43f5e" style="background: #f43f5e"></button>
              <button class="pin-color-btn" data-color="#f97316" style="background: #f97316"></button>
              <button class="pin-color-btn" data-color="#eab308" style="background: #eab308"></button>
              <button class="pin-color-btn" data-color="#22c55e" style="background: #22c55e"></button>
              <button class="pin-color-btn" data-color="#14b8a6" style="background: #14b8a6"></button>
              <button class="pin-color-btn" data-color="#3b82f6" style="background: #3b82f6"></button>
              <button class="pin-color-btn" data-color="#8b5cf6" style="background: #8b5cf6"></button>
              <button class="pin-color-btn" data-color="#ec4899" style="background: #ec4899"></button>
              <button class="pin-color-btn" data-color="#ffffff" style="background: #ffffff"></button>
            </div>

            <div style="margin-top:8px;">
              <label class="toolbar-toggle">
                <input type="checkbox" id="destHideLabel" />
                <span>Hide label on map</span>
              </label>
            </div>
          </div>
          <div class="popup-actions">
            <button class="btn danger" onclick="deleteCurrentDest()">Delete</button>
            <button class="btn secondary" onclick="closeDestEditorModal()">Cancel</button>
            <button class="btn primary" onclick="saveDestChanges()">Save</button>
          </div>
        </div>
      </div>

      <!-- Pin Context Menu -->
      <div class="context-menu hidden" id="pinContextMenu">
        <div class="context-menu-item" data-action="editPin">Edit Pin</div>
        <div class="context-menu-item" data-action="measureFrom">
          Measure From Here
        </div>
        <div class="context-menu-item" data-action="panToPin">Pan to Pin</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" data-action="deletePin">
          Delete Pin
        </div>
      </div>

      <!-- Map Sidebar Context Menu -->
      <div class="context-menu hidden" id="mapSidebarContextMenu">
        <div class="context-menu-item" data-action="editMap">
          Edit Map Settings
        </div>
        <div class="context-menu-item" data-action="duplicateMap">
          Duplicate Map
        </div>
        <div class="context-menu-item" data-action="renameMap">Rename Map</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item owner-only" data-action="toggleHideMap">Toggle Hidden</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" data-action="deleteMap">
          Delete Map
        </div>
      </div>

      <!-- Pin Sidebar Context Menu -->
      <div class="context-menu hidden" id="pinSidebarContextMenu">
        <div class="context-menu-item" data-action="editPinSidebar">
          Edit Pin
        </div>
        <div class="context-menu-item" data-action="panToPinSidebar">
          Pan to Pin
        </div>
        <div class="context-menu-item" data-action="duplicatePinSidebar">
          Duplicate Pin
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" data-action="deletePinSidebar">
          Delete Pin
        </div>
      </div>

      <!-- Map Canvas Context Menu -->
      <div class="context-menu hidden" id="mapCanvasContextMenu">
        <div class="context-menu-item" data-action="addPinHere">
          Add Pin Here
        </div>
        <div class="context-menu-item" data-action="measureFromHere">
          Start Measurement
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" data-action="centerMap">Center Map</div>
        <div class="context-menu-item" data-action="fitToScreen">
          Fit to Screen
        </div>
      </div>

      <!-- Table Context Menu (for Write view) -->
      <div class="context-menu hidden" id="tableContextMenu">
        <div class="context-menu-item" data-action="addRowAbove">
          Add Row Above
        </div>
        <div class="context-menu-item" data-action="addRowBelow">
          Add Row Below
        </div>
        <div class="context-menu-item" data-action="addColLeft">
          Add Column Left
        </div>
        <div class="context-menu-item" data-action="addColRight">
          Add Column Right
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" data-action="deleteRow">Delete Row</div>
        <div class="context-menu-item" data-action="deleteCol">
          Delete Column
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-submenu">
          <div class="context-menu-item has-submenu">Header Color ‚ñ∏</div>
          <div class="context-submenu">
            <div class="context-menu-item" data-action="headerColor-default">
              Default
            </div>
            <div class="context-menu-item" data-action="headerColor-gold">
              Gold
            </div>
            <div class="context-menu-item" data-action="headerColor-dark">
              Dark
            </div>
            <div class="context-menu-item" data-action="headerColor-none">
              No Header
            </div>
          </div>
        </div>
        <div class="context-menu-submenu">
          <div class="context-menu-item has-submenu">Border Style ‚ñ∏</div>
          <div class="context-submenu">
            <div class="context-menu-item" data-action="borderStyle-solid">
              Solid
            </div>
            <div class="context-menu-item" data-action="borderStyle-dashed">
              Dashed
            </div>
            <div class="context-menu-item" data-action="borderStyle-none">
              No Borders
            </div>
          </div>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" data-action="deleteTable">
          Delete Table
        </div>
      </div>

      <!-- Column Context Menu -->
      <div class="context-menu hidden" id="columnContextMenu">
        <div class="context-menu-submenu">
          <div class="context-menu-item has-submenu">Borders ‚ñ∏</div>
          <div class="context-submenu">
            <div class="context-menu-item" data-action="colBorder-all">
              All Borders
            </div>
            <div class="context-menu-item" data-action="colBorder-outer">
              Outer Only
            </div>
            <div class="context-menu-item" data-action="colBorder-none">
              No Borders
            </div>
            <div class="context-menu-item" data-action="colBorder-dashed">
              Dashed
            </div>
          </div>
        </div>
        <div class="context-menu-submenu">
          <div class="context-menu-item has-submenu">Background ‚ñ∏</div>
          <div class="context-submenu">
            <div class="context-menu-item" data-action="colBg-none">None</div>
            <div class="context-menu-item" data-action="colBg-dark">Dark</div>
            <div class="context-menu-item" data-action="colBg-medium">
              Medium
            </div>
            <div class="context-menu-item" data-action="colBg-gold">
              Gold Tint
            </div>
          </div>
        </div>
        <div class="context-menu-submenu">
          <div class="context-menu-item has-submenu">Container ‚ñ∏</div>
          <div class="context-submenu">
            <div class="context-menu-item" data-action="containerBorder-dashed">Dashed Border</div>
            <div class="context-menu-item" data-action="containerBorder-solid">Solid Border</div>
            <div class="context-menu-item" data-action="containerBorder-none">No Border</div>
          </div>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" data-action="addColBefore">
          Add Column Before
        </div>
        <div class="context-menu-item" data-action="addColAfter">
          Add Column After
        </div>
        <div class="context-menu-item" data-action="deleteColumn">
          Delete Column
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" data-action="deleteColumns">
          Delete All Columns
        </div>
      </div>

      <!-- Tag Finder Panel -->
      <div class="tag-finder-panel hidden" id="tagFinderPanel">
        <div class="tag-finder-header">
          <span class="tag-finder-title"
            >Tag: <strong id="tagFinderName">-</strong></span
          >
          <button class="icon-btn" id="closeTagFinder">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M18 6L6 18M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="tag-finder-results" id="tagFinderResults"></div>
      </div>

      <!-- Wiki Link Modal (for Write view) -->
      <div class="popup-overlay hidden" id="wikiLinkModal">
        <div class="popup-modal">
          <div class="popup-header">
            <h3>Link to Card or Pin</h3>
            <button class="icon-btn popup-close" id="closeWikiLinkModal">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="popup-body">
            <label class="popup-label">Search Cards & Pins</label>
            <div class="search-input-wrapper">
              <input
                type="text"
                class="popup-input"
                id="wikiLinkSearch"
                placeholder="Type to search..."
                autocomplete="off"
              />
              <div class="search-results" id="wikiLinkSearchResults"></div>
            </div>
            <div class="wiki-link-preview hidden" id="wikiLinkPreview">
              <span class="wiki-link-type"></span>
              <span class="wiki-link-name"></span>
            </div>
          </div>
          <div class="popup-actions">
            <button class="btn secondary" id="cancelWikiLink">Cancel</button>
            <button class="btn primary" id="confirmWikiLink" disabled>
              Insert Link
            </button>
          </div>
        </div>
      </div>

      <!-- Link Insert Modal -->
      <div class="popup-overlay hidden" id="linkModal">
        <div class="popup-modal">
          <div class="popup-header">
            <h3>Insert Link</h3>
            <button class="icon-btn popup-close" id="closeLinkModal">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="popup-body">
            <label class="popup-label">Link Text</label>
            <input
              type="text"
              class="popup-input"
              id="linkTextInput"
              placeholder="Display text"
            />
            <label class="popup-label">URL</label>
            <input
              type="text"
              class="popup-input"
              id="linkUrlInput"
              placeholder="https://..."
            />
          </div>
          <div class="popup-actions">
            <button class="btn secondary" id="cancelLink">Cancel</button>
            <button class="btn primary" id="confirmLink">Insert</button>
          </div>
        </div>
      </div>

      <!-- Table Insert Modal -->
      <div class="popup-overlay hidden" id="tableModal">
        <div class="popup-modal">
          <div class="popup-header">
            <h3>Insert Table</h3>
            <button class="icon-btn popup-close" id="closeTableModal">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="popup-body">
            <div class="table-size-inputs">
              <div class="size-input-group">
                <label>Rows</label>
                <input
                  type="number"
                  id="tableRows"
                  value="3"
                  min="1"
                  max="20"
                />
              </div>
              <div class="size-input-group">
                <label>Columns</label>
                <input
                  type="number"
                  id="tableCols"
                  value="3"
                  min="1"
                  max="10"
                />
              </div>
            </div>
            <div class="table-preview-grid" id="tablePreviewGrid"></div>
          </div>
          <div class="popup-actions">
            <button class="btn secondary" id="cancelTable">Cancel</button>
            <button class="btn primary" id="confirmTable">Insert</button>
          </div>
        </div>
      </div>

      <!-- Context Menu -->
      <div class="context-menu hidden" id="contextMenu">
        <div class="context-menu-item" data-action="edit">Edit Details</div>
        <div class="context-menu-item" data-action="duplicate">Duplicate</div>
        <div class="context-menu-item owner-only" data-action="toggleHideCard">Toggle Hidden</div>
        <div class="context-menu-item" data-action="rollDice">
          Insert Dice Roll
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-submenu">
          <div class="context-menu-item has-submenu">Size Preset ‚ñ∏</div>
          <div class="context-submenu">
            <div class="context-menu-item" data-action="size-small">
              Small (150√ó100)
            </div>
            <div class="context-menu-item" data-action="size-medium">
              Medium (200√ó150)
            </div>
            <div class="context-menu-item" data-action="size-large">
              Large (280√ó200)
            </div>
            <div class="context-menu-item" data-action="size-tall">
              Tall (200√ó300)
            </div>
            <div class="context-menu-item" data-action="size-wide">
              Wide (350√ó150)
            </div>
          </div>
        </div>
        <div class="context-menu-submenu">
          <div class="context-menu-item has-submenu">Change Design ‚ñ∏</div>
          <div class="context-submenu">
            <div class="context-menu-item" data-action="design-default">
              Default
            </div>
            <div class="context-menu-item" data-action="design-minimal">
              Minimal
            </div>
            <div class="context-menu-item" data-action="design-bordered">
              Bordered
            </div>
            <div class="context-menu-item" data-action="design-gradient">
              Gradient
            </div>
            <div class="context-menu-item" data-action="design-glass">
              Glass
            </div>
            <div class="context-menu-item" data-action="design-parchment">
              Parchment
            </div>
            <div class="context-menu-item" data-action="design-dark-steel">
              Dark Steel
            </div>
            <div class="context-menu-item" data-action="design-neon">
              Neon
            </div>
            <div class="context-menu-item" data-action="design-worn">
              Worn Paper
            </div>
            <div class="context-menu-item" data-action="design-frost">
              Frost
            </div>
            <div class="context-menu-item" data-action="design-ember">
              Ember
            </div>
            <div class="context-menu-item" data-action="design-shadow">
              Shadow
            </div>
          </div>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" data-action="hideTitle">
          Toggle Hide Title
        </div>
        <div class="context-menu-item" data-action="hideTags">
          Toggle Hide Tags
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" data-action="delete">Delete</div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Left Sidebar -->
        <aside class="sidebar" id="sidebar">
          <!-- Boards Section (Board View Only) -->
          <div class="sidebar-section boards-section" id="boardsSection">
            <div class="section-header">
              <span>Boards</span>
              <button class="add-btn" id="addBoardBtn">
                +
              </button>
            </div>
            <div class="boards-list" id="boardsList"></div>
          </div>

          <!-- Card Templates (Board View Only) - Collapsible -->
          <div class="sidebar-section templates-section" id="templatesSection">
            <div class="section-header collapsible" id="templatesHeader">
              <span>Add Card</span>
              <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="card-templates" id="cardTemplates">
              <div class="template-category">Basic</div>
              <button class="template-btn" data-type="character">
                <span
                  class="template-color"
                  style="background: var(--cyan)"
                ></span>
                <span>Character</span>
              </button>
              <button class="template-btn" data-type="location">
                <span
                  class="template-color"
                  style="background: var(--green)"
                ></span>
                <span>Location</span>
              </button>
              <button class="template-btn" data-type="item">
                <span
                  class="template-color"
                  style="background: var(--gold)"
                ></span>
                <span>Item</span>
              </button>
              <button class="template-btn" data-type="note">
                <span
                  class="template-color"
                  style="background: var(--purple)"
                ></span>
                <span>Note</span>
              </button>
              <button class="template-btn" data-type="quest">
                <span
                  class="template-color"
                  style="background: var(--ember)"
                ></span>
                <span>Quest</span>
              </button>

              <div class="template-category">Data</div>
              <button class="template-btn" data-type="statblock">
                <span
                  class="template-color"
                  style="background: var(--rose)"
                ></span>
                <span>Stat Block</span>
              </button>
              <button class="template-btn" data-type="chart">
                <span
                  class="template-color"
                  style="background: var(--teal)"
                ></span>
                <span>Chart</span>
              </button>
              <button class="template-btn" data-type="bar">
                <span
                  class="template-color"
                  style="background: var(--hp-red)"
                ></span>
                <span>Bar Card</span>
              </button>

              <div class="template-category">Trackers</div>
              <button class="template-btn" data-type="stress">
                <span
                  class="template-color"
                  style="background: var(--stress-orange)"
                ></span>
                <span>Stress/Clock</span>
              </button>
              <button class="template-btn" data-type="injury">
                <span
                  class="template-color"
                  style="background: var(--rose)"
                ></span>
                <span>Injury Track</span>
              </button>
              <button class="template-btn" data-type="body">
                <span
                  class="template-color"
                  style="background: var(--purple)"
                ></span>
                <span>Body Map</span>
              </button>
              <button class="template-btn" data-type="mood">
                <span
                  class="template-color"
                  style="background: #e879a8"
                ></span>
                <span>Mood</span>
              </button>

              <div class="template-category">RPG</div>
              <button class="template-btn" data-type="personality">
                <span
                  class="template-color"
                  style="background: #c084fc"
                ></span>
                <span>Personality</span>
              </button>
              <button class="template-btn" data-type="attributes">
                <span
                  class="template-color"
                  style="background: #60a5fa"
                ></span>
                <span>Attributes</span>
              </button>
              <button class="template-btn" data-type="inventory">
                <span
                  class="template-color"
                  style="background: #a78bfa"
                ></span>
                <span>Inventory</span>
              </button>
              <button class="template-btn" data-type="currency">
                <span
                  class="template-color"
                  style="background: #fbbf24"
                ></span>
                <span>Currency</span>
              </button>
              <button class="template-btn" data-type="randomizer">
                <span
                  class="template-color"
                  style="background: #e879a8"
                ></span>
                <span>Randomizer</span>
              </button>
              <button class="template-btn" data-type="ability">
                <span
                  class="template-color"
                  style="background: #a78bfa"
                ></span>
                <span>Ability</span>
              </button>

              <div class="template-category">Media</div>
              <button class="template-btn" data-type="image">
                <span class="template-color" style="background: #888"></span>
                <span>Image</span>
              </button>
              <button class="template-btn" data-type="text">
                <span
                  class="template-color"
                  style="background: var(--gold-dark)"
                ></span>
                <span>Text Block</span>
              </button>

              <div class="template-category">Reference</div>
              <button class="template-btn" data-type="ref-map">
                <span class="template-color" style="background: #22c55e"></span>
                <span>Map View</span>
              </button>
              <button class="template-btn" data-type="ref-chapter">
                <span class="template-color" style="background: #a78bfa"></span>
                <span>Chapter View</span>
              </button>
              <button class="template-btn" data-type="ref-timeline">
                <span class="template-color" style="background: #f59e0b"></span>
                <span>Timeline View</span>
              </button>
              <button class="template-btn" data-type="ref-music">
                <span class="template-color" style="background: #ec4899"></span>
                <span>Music Player</span>
              </button>
            </div>
          </div>

          <!-- Maps Section (Map View Only) -->
          <div class="sidebar-section maps-section hidden" id="mapsSection">
            <div class="section-header">
              <span>Maps</span>
              <button class="add-btn" id="addMapBtn">+</button>
            </div>
            <div class="maps-list" id="mapsList"></div>
          </div>

          <!-- Pins Section (Map View Only) -->
          <div class="sidebar-section pins-section hidden" id="pinsSection">
            <div class="section-header">
              <span>Pins</span>
            </div>
            <div class="pins-list" id="pinsList">
              <div class="empty-pins-message">Click on the map to add pins</div>
            </div>
          </div>

          <!-- Tags Section (Map View Only) -->
          <div class="sidebar-section tags-section hidden" id="tagsSection">
            <div class="section-header">
              <span>Tags</span>
            </div>
            <div class="tags-cloud" id="tagsCloud">
              <div class="empty-tags-message">
                Add tags to pins to see them here
              </div>
            </div>
          </div>

          <!-- Chapters Section (Write View Only) -->
          <div
            class="sidebar-section chapters-section hidden"
            id="chaptersSection"
          >
            <div class="section-header">
              <span>Pages</span>
              <div style="display:flex;gap:4px;">
                <button class="add-btn" id="addFolderBtn" style="font-size:11px;opacity:0.7;padding:2px 5px;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
                </button>
                <button class="add-btn" id="addChapterBtn">
                  +
                </button>
              </div>
            </div>
            <div class="chapters-list" id="chaptersList"></div>
          </div>

          <!-- Timelines Section (Timeline View Only) -->
          <div class="sidebar-section timelines-section hidden" id="timelinesSection">
            <div class="section-header">
              <span>Timelines</span>
              <button class="add-btn" id="addTimelineBtn">+</button>
            </div>
            <div class="timelines-list" id="timelinesList"></div>
          </div>

          <!-- Timeline Templates Section -->
          <div class="sidebar-section timeline-templates-section hidden" id="timelineTemplatesSection">
            <div class="section-header collapsible" id="timelineTemplatesHeader">
              <span>Calendar Templates</span>
              <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="timeline-templates" id="timelineTemplates">
              <button class="template-btn" data-calendar="gregorian">
                <span class="template-color" style="background: #3b82f6"></span>
                <span>Gregorian (Real World)</span>
              </button>
              <button class="template-btn" data-calendar="harptos">
                <span class="template-color" style="background: #8b5cf6"></span>
                <span>Harptos (Forgotten Realms)</span>
              </button>
              <button class="template-btn" data-calendar="exandrian">
                <span class="template-color" style="background: #f43f5e"></span>
                <span>Exandrian (Critical Role)</span>
              </button>
              <button class="template-btn" data-calendar="golarion">
                <span class="template-color" style="background: #22c55e"></span>
                <span>Golarion (Pathfinder)</span>
              </button>
              <button class="template-btn" data-calendar="eberron">
                <span class="template-color" style="background: #eab308"></span>
                <span>Eberron</span>
              </button>
              <button class="template-btn" data-calendar="greyhawk">
                <span class="template-color" style="background: #14b8a6"></span>
                <span>Greyhawk (Oerth)</span>
              </button>
              <button class="template-btn" data-calendar="custom">
                <span class="template-color" style="background: #a89880"></span>
                <span>Custom Calendar</span>
              </button>
            </div>
          </div>

          <!-- Timeline Moon & Date Section -->
          <div class="sidebar-section timeline-info-section hidden" id="timelineInfoSection">
            <div class="section-header">
              <span>Current Date</span>
            </div>
            <div class="timeline-date-display" id="timelineDateDisplay">
              <div class="tl-date-main" id="tlDateMain">No timeline selected</div>
              <div class="tl-moon-display" id="tlMoonDisplay"></div>
            </div>
            <div class="tl-date-controls">
              <button class="btn secondary sm" id="tlPrevDay">‚óÄ Day</button>
              <button class="btn primary sm" id="tlSetDateBtn">Set Date</button>
              <button class="btn secondary sm" id="tlNextDay">Day ‚ñ∂</button>
            </div>
            <div class="tl-sidebar-tags">
              <label class="detail-label" style="margin-top:10px;">Timeline Tags</label>
              <input type="text" class="detail-input" id="tlTagsInput" placeholder="Type tag, press comma..." />
              <div class="chapter-tags-display" id="tlTagsDisplay"></div>
            </div>
            <div style="margin-top:10px;">
              <button class="btn secondary sm" id="editCalendarBtn" style="width:100%;">‚úé Edit Calendar</button>
            </div>
          </div>

          <!-- Combat Sidebar Sections -->
          <div class="sidebar-section combat-add-section hidden" id="combatAddSection">
            <div class="section-header"><span>Add Combatant</span></div>
            <div style="padding:8px 12px;display:flex;flex-direction:column;gap:6px;">
              <input type="text" class="detail-input" id="ctAddName" placeholder="Name..." />
              <div style="display:flex;gap:6px;">
                <input type="number" class="detail-input" id="ctAddInit" placeholder="Init mod" style="flex:1;" />
                <input type="number" class="detail-input" id="ctAddHP" placeholder="Max HP" style="flex:1;" />
              </div>
              <input type="number" class="detail-input" id="ctAddAC" placeholder="AC (optional)" />
              <label style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-muted);cursor:pointer;">
                <input type="checkbox" id="ctAddHidden" style="accent-color:var(--gold);" /> Start Hidden
              </label>
              <button class="btn primary full-width" id="ctAddBtn">+ Add Combatant</button>
              <button class="btn secondary full-width" id="ctClearAll" style="font-size:11px;margin-top:2px;">Clear Encounter</button>
            </div>
          </div>
          <div class="sidebar-section combat-encounters-section hidden" id="combatEncountersSection">
            <div class="section-header" style="cursor:pointer;" onclick="document.getElementById('ctEncountersList').classList.toggle('hidden')"><span>Saved Encounters</span></div>
            <div id="ctEncountersList" style="padding:4px 8px;">
              <div class="empty-pins-message">Save encounters for quick re-use</div>
            </div>
            <div style="padding:4px 12px 8px;">
              <button class="btn secondary sm full-width" id="ctSaveEncounter">üíæ Save Current</button>
            </div>
          </div>

          <!-- Faction Sidebar Sections -->
          <div class="sidebar-section factions-list-section hidden" id="factionsListSection">
            <div class="section-header"><span>Factions</span><button class="icon-btn sm" id="randomFactionBtn" title="Generate a random faction">üé≤</button></div>
            <div id="factionsList" style="padding:4px 8px;">
              <div class="empty-pins-message">No factions yet</div>
            </div>
            <div style="padding:4px 12px 8px;">
              <button class="btn primary sm full-width" id="addFactionBtn">+ Add Faction</button>
            </div>
          </div>
          <div class="sidebar-section contacts-list-section hidden" id="contactsListSection">
            <div class="section-header"><span>Contacts</span><button class="icon-btn sm" id="randomContactBtn" title="Generate a random contact">üé≤</button></div>
            <div id="contactsList" style="padding:4px 8px;">
              <div class="empty-pins-message">No contacts yet</div>
            </div>
            <div style="padding:4px 12px 8px;">
              <button class="btn primary sm full-width" id="addContactBtn">+ Add Contact</button>
            </div>
          </div>
          <div class="sidebar-section orgs-list-section hidden" id="orgsListSection">
            <div class="section-header"><span>Organizations</span><button class="icon-btn sm" id="randomOrgBtn" title="Generate a random organization">üé≤</button></div>
            <div id="orgsList" style="padding:4px 8px;">
              <div class="empty-pins-message">No organizations yet</div>
            </div>
            <div style="padding:4px 12px 8px;">
              <button class="btn primary sm full-width" id="addOrgBtn">+ Add Organization</button>
            </div>
          </div>
        </aside>

        <!-- Board View -->
        <div class="canvas-container" id="boardView">
          <div class="canvas" id="canvas">
            <svg class="connections-layer" id="connectionsLayer"></svg>
          </div>

          <div class="zoom-controls">
            <button class="zoom-btn" id="zoomOutBtn">‚àí</button>
            <span class="zoom-level" id="zoomLevel">100%</span>
            <button class="zoom-btn" id="zoomInBtn">+</button>
            <button class="zoom-btn" id="zoomFitBtn">
              ‚óª
            </button>
            <button class="zoom-btn" id="snapToggleBtn" style="font-size:11px;opacity:0.5">
              ‚äû
            </button>
          </div>

          <div class="canvas-tools">
            <button
              class="tool-btn active"
              data-tool="select"
             
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path d="M4 4l16 8-8 2-2 8z" />
              </svg>
            </button>
            <button
              class="tool-btn"
              data-tool="connect"
             
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="5" cy="12" r="3" />
                <circle cx="19" cy="12" r="3" />
                <path d="M8 12h8" />
              </svg>
            </button>
            <button class="tool-btn" data-tool="pan">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"
                />
              </svg>
            </button>
            <div class="tool-divider"></div>
            <button class="tool-btn" data-tool="text">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M4 7V4h16v3M9 20h6M12 4v16" />
              </svg>
            </button>
            <div class="tool-divider"></div>
            <button class="tool-btn" id="undoBtn" onclick="undo()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10h10a5 5 0 015 5v0a5 5 0 01-5 5H8M3 10l4-4M3 10l4 4"/></svg>
            </button>
            <button class="tool-btn" id="redoBtn" onclick="redo()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10H11a5 5 0 00-5 5v0a5 5 0 005 5h5M21 10l-4-4M21 10l-4 4"/></svg>
            </button>
            <button class="tool-btn" id="copyBtn" onclick="copySelected()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
            </button>
            <button class="tool-btn" id="pasteBtn" onclick="pasteCards()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="8" y="2" width="8" height="4" rx="1"/><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/></svg>
            </button>
          </div>

          <div
            class="connection-mode-indicator hidden"
            id="connectionIndicator"
          >
            <span
              >Click another card to connect, or press Escape to cancel</span
            >
            <button class="btn secondary sm" id="cancelConnection">
              Cancel
            </button>
          </div>

          <!-- Unified Photoshop-Style Board Toolbar -->
          <div class="board-toolbar" id="boardToolbar" data-mode="none">
            <div class="toolbar-section toolbar-info">
              <span class="toolbar-icon" id="toolbarIcon">‚ú¶</span>
              <div class="toolbar-title-group">
                <span class="toolbar-label" id="toolbarLabel">Selection</span>
                <span class="toolbar-status" id="toolbarStatus">Select a card or connection to edit</span>
              </div>
            </div>

            <!-- Card Controls -->
            <div class="toolbar-section toolbar-controls" id="cardControls" style="display: none;">
              <div class="toolbar-control-group">
                <label>Accent</label>
                <input type="color" id="cardTopAccentPicker" value="#4ecdc4" />
              </div>
              <div class="toolbar-control-group">
                <label>Title</label>
                <input type="color" id="toolbarTitleColor" value="#f5ede0" />
              </div>
              <div class="toolbar-control-group">
                <label>Label</label>
                <input type="color" id="toolbarLabelColor" value="#4ecdc4" />
              </div>
              <div class="toolbar-control-group">
                <label>Text</label>
                <input type="color" id="toolbarTextColor" value="#a89880" />
              </div>
              <div class="toolbar-control-group">
                <label>BG</label>
                <input type="color" id="toolbarBgColor" value="#0a0a0a" />
              </div>
              <div class="toolbar-divider-v"></div>
              <div class="toolbar-control-group">
                <label>Border</label>
                <select id="toolbarBorderStyle" class="toolbar-select sm">
                  <option value="none">None</option>
                  <option value="solid">Solid</option>
                  <option value="dashed">Dashed</option>
                  <option value="double">Double</option>
                  <option value="groove">Groove</option>
                  <option value="ridge">Ridge</option>
                </select>
              </div>
              <div class="toolbar-control-group">
                <label>B.Color</label>
                <input type="color" id="toolbarBorderColor" value="#4ecdc4" />
              </div>
              <div class="toolbar-divider-v"></div>
              <div class="toolbar-control-group">
                <label>Design</label>
                <select id="toolbarCardDesign" class="toolbar-select sm">
                  <option value="">Default</option>
                  <option value="minimal">Minimal</option>
                  <option value="bordered">Bordered</option>
                  <option value="gradient">Gradient</option>
                  <option value="glass">Glass</option>
                  <option value="parchment">Parchment</option>
                  <option value="dark-steel">Dark Steel</option>
                  <option value="neon">Neon</option>
                  <option value="worn">Worn Paper</option>
                  <option value="frost">Frost</option>
                  <option value="ember">Ember</option>
                  <option value="shadow">Shadow</option>
                  <option value="bloodstone">Bloodstone</option>
                  <option value="arcane">Arcane</option>
                  <option value="nature">Nature</option>
                  <option value="holy">Holy</option>
                  <option value="void">Void</option>
                  <option value="scifi">Sci-Fi</option>
                </select>
              </div>
              <div class="toolbar-control-group">
                <label>Font</label>
                <select id="toolbarFontFamily" class="toolbar-select sm">
                  <option value="Inter">Inter</option>
                  <option value="Poppins">Poppins</option>
                  <option value="Montserrat">Montserrat</option>
                  <option value="Raleway">Raleway</option>
                  <option value="Oswald">Oswald</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Merriweather">Merriweather</option>
                  <option value="Lora">Lora</option>
                  <option value="Playfair Display">Playfair Display</option>
                  <option value="Cinzel">Cinzel</option>
                  <option value="Crimson Text">Crimson Text</option>
                  <option value="EB Garamond">EB Garamond</option>
                  <option value="Libre Baskerville">Libre Baskerville</option>
                  <option value="Spectral">Spectral</option>
                  <option value="Vollkorn">Vollkorn</option>
                  <option value="Cormorant Garamond">Cormorant Garamond</option>
                  <option value="Alegreya">Alegreya</option>
                  <option value="Dancing Script">Dancing Script</option>
                  <option value="Satisfy">Satisfy</option>
                  <option value="Caveat">Caveat</option>
                  <option value="Permanent Marker">Permanent Marker</option>
                  <option value="Special Elite">Special Elite</option>
                  <option value="UnifrakturMaguntia">Blackletter</option>
                  <option value="Source Code Pro">Source Code Pro</option>
                  <option value="Roboto Mono">Roboto Mono</option>
                  <option value="Press Start 2P">Press Start 2P</option>
                  <option value="VT323">VT323</option>
                  <option value="monospace">Monospace</option>
                </select>
              </div>
              <div class="toolbar-control-group">
                <label>Size</label>
                <select id="toolbarFontSize" class="toolbar-select sm">
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                  <option value="13">13</option>
                  <option value="14" selected>14</option>
                  <option value="16">16</option>
                  <option value="18">18</option>
                  <option value="20">20</option>
                  <option value="24">24</option>
                  <option value="28">28</option>
                  <option value="32">32</option>
                </select>
              </div>
              <div class="toolbar-control-group toolbar-toggle-group">
                <label class="toolbar-toggle">
                  <input type="checkbox" id="toolbarSharpEdge" />
                  <span>Sharp</span>
                </label>
                <label class="toolbar-toggle">
                  <input type="checkbox" id="toolbarHideHeader" />
                  <span>Hdr</span>
                </label>
                <label class="toolbar-toggle">
                  <input type="checkbox" id="toolbarHideTags" />
                  <span>Tags</span>
                </label>
              </div>
            </div>

            <!-- Multi-Select Controls -->
            <div class="toolbar-section toolbar-controls" id="multiControls" style="display: none;">
              <div class="toolbar-control-group">
                <label>Accent</label>
                <input type="color" id="multiTopAccent" value="#4ecdc4" />
              </div>
              <div class="toolbar-control-group">
                <label>Title</label>
                <input type="color" id="multiTitleColor" value="#f5ede0" />
              </div>
              <div class="toolbar-control-group">
                <label>Text</label>
                <input type="color" id="multiTextColor" value="#a89880" />
              </div>
              <div class="toolbar-control-group">
                <label>BG</label>
                <input type="color" id="multiBgColor" value="#0a0a0a" />
              </div>
              <div class="toolbar-divider-v"></div>
              <div class="toolbar-control-group">
                <label>Border</label>
                <select id="multiBorderStyle" class="toolbar-select sm">
                  <option value="">‚Äî</option>
                  <option value="none">None</option>
                  <option value="solid">Solid</option>
                  <option value="dashed">Dashed</option>
                  <option value="double">Double</option>
                </select>
              </div>
              <div class="toolbar-control-group">
                <label>Design</label>
                <select id="multiDesign" class="toolbar-select sm">
                  <option value="">‚Äî</option>
                  <option value="default">Default</option>
                  <option value="minimal">Minimal</option>
                  <option value="bordered">Bordered</option>
                  <option value="gradient">Gradient</option>
                  <option value="glass">Glass</option>
                  <option value="parchment">Parchment</option>
                  <option value="dark-steel">Dark Steel</option>
                  <option value="neon">Neon</option>
                  <option value="worn">Worn Paper</option>
                  <option value="frost">Frost</option>
                  <option value="ember">Ember</option>
                  <option value="shadow">Shadow</option>
                  <option value="bloodstone">Bloodstone</option>
                  <option value="arcane">Arcane</option>
                  <option value="nature">Nature</option>
                  <option value="holy">Holy</option>
                  <option value="void">Void</option>
                  <option value="scifi">Sci-Fi</option>
                </select>
              </div>
              <div class="toolbar-control-group toolbar-toggle-group">
                <label class="toolbar-toggle">
                  <input type="checkbox" id="multiHideHeader" />
                  <span>Hdr</span>
                </label>
                <label class="toolbar-toggle">
                  <input type="checkbox" id="multiHideTags" />
                  <span>Tags</span>
                </label>
                <label class="toolbar-toggle">
                  <input type="checkbox" id="multiSharpEdge" />
                  <span>Sharp</span>
                </label>
              </div>
              <div class="toolbar-control-group">
                <label>Font</label>
                <select id="multiFontFamily" class="toolbar-select sm">
                  <option value="">‚Äî</option>
                  <option value="Inter">Inter</option>
                  <option value="Poppins">Poppins</option>
                  <option value="Montserrat">Montserrat</option>
                  <option value="Raleway">Raleway</option>
                  <option value="Oswald">Oswald</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Merriweather">Merriweather</option>
                  <option value="Lora">Lora</option>
                  <option value="Playfair Display">Playfair Display</option>
                  <option value="Cinzel">Cinzel</option>
                  <option value="Crimson Text">Crimson Text</option>
                  <option value="EB Garamond">EB Garamond</option>
                  <option value="Libre Baskerville">Libre Baskerville</option>
                  <option value="Spectral">Spectral</option>
                  <option value="Vollkorn">Vollkorn</option>
                  <option value="Cormorant Garamond">Cormorant Garamond</option>
                  <option value="Alegreya">Alegreya</option>
                  <option value="Dancing Script">Dancing Script</option>
                  <option value="Satisfy">Satisfy</option>
                  <option value="Caveat">Caveat</option>
                  <option value="Permanent Marker">Permanent Marker</option>
                  <option value="Special Elite">Special Elite</option>
                  <option value="UnifrakturMaguntia">Blackletter</option>
                  <option value="Source Code Pro">Source Code Pro</option>
                  <option value="Roboto Mono">Roboto Mono</option>
                  <option value="Press Start 2P">Press Start 2P</option>
                  <option value="VT323">VT323</option>
                  <option value="monospace">Monospace</option>
                </select>
              </div>
              <div class="toolbar-control-group">
                <label>Size</label>
                <select id="multiFontSize" class="toolbar-select sm">
                  <option value="">‚Äî</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                  <option value="13">13</option>
                  <option value="14">14</option>
                  <option value="16">16</option>
                  <option value="18">18</option>
                  <option value="20">20</option>
                  <option value="24">24</option>
                  <option value="28">28</option>
                  <option value="32">32</option>
                </select>
              </div>
            </div>

            <!-- Connection Controls -->
            <div class="toolbar-section toolbar-controls" id="connectionControls" style="display: none;">
              <div class="toolbar-control-group">
                <label>Color</label>
                <input type="color" id="connColorPicker" value="#4ecdc4" />
              </div>
              <div class="toolbar-control-group toolbar-toggle-group">
                <label class="toolbar-toggle">
                  <input type="checkbox" id="connGlowToggle" />
                  <span>Glow</span>
                </label>
              </div>
              <div class="toolbar-divider-v"></div>
              <div class="toolbar-control-group">
                <label>Style</label>
                <select id="connStyleSelect" class="toolbar-select">
                  <option value="solid">Solid</option>
                  <option value="dashed">Dashed</option>
                  <option value="dotted">Dotted</option>
                  <option value="dashdot">Dash-Dot</option>
                  <option value="longdash">Long Dash</option>
                  <option value="double">Double</option>
                  <option value="railroad">Railroad</option>
                  <option value="energy">Energy</option>
                  <option value="morse">Morse</option>
                  <option value="tapered">Tapered</option>
                  <option value="chain">Chain</option>
                  <option value="barbed">Barbed</option>
                </select>
              </div>
              <div class="toolbar-control-group">
                <label>Width</label>
                <select id="connWidthSelect" class="toolbar-select">
                  <option value="1">Thin</option>
                  <option value="2" selected>Normal</option>
                  <option value="3">Thick</option>
                  <option value="5">Bold</option>
                </select>
              </div>
              <div class="toolbar-divider-v"></div>
              <div class="toolbar-control-group">
                <label>Path</label>
                <select id="connCurveSelect" class="toolbar-select">
                  <option value="up" selected>Arc Up</option>
                  <option value="down">Arc Down</option>
                  <option value="straight">Straight</option>
                  <option value="swirl">Swirl</option>
                  <option value="step">Step (L-shape)</option>
                  <option value="zigzag">Zigzag</option>
                  <option value="wave">Wave</option>
                  <option value="spring">Spring</option>
                  <option value="loop">Loop</option>
                  <option value="sstep">S-Step</option>
                  <option value="hstep">H-Step</option>
                  <option value="arc3">Triple Arc</option>
                  <option value="organic">Organic</option>
                  <option value="elbow">Elbow</option>
                </select>
              </div>
              <div class="toolbar-control-group">
                <label>Arrow</label>
                <select id="connArrowSelect" class="toolbar-select">
                  <option value="none">None</option>
                  <optgroup label="Arrows">
                    <option value="end">End ‚Üí</option>
                    <option value="start">‚Üê Start</option>
                    <option value="both">‚Üê Both ‚Üí</option>
                  </optgroup>
                  <optgroup label="Diamonds">
                    <option value="diamond-end">End ‚óÜ</option>
                    <option value="diamond-start">‚óÜ Start</option>
                    <option value="diamond-both">‚óÜ Both ‚óÜ</option>
                  </optgroup>
                  <optgroup label="Circles">
                    <option value="circle-end">End ‚óè</option>
                    <option value="circle-start">‚óè Start</option>
                    <option value="circle-both">‚óè Both ‚óè</option>
                  </optgroup>
                  <optgroup label="Squares">
                    <option value="square-end">End ‚ñ†</option>
                    <option value="square-start">‚ñ† Start</option>
                    <option value="square-both">‚ñ† Both ‚ñ†</option>
                  </optgroup>
                  <optgroup label="Tee/Bar">
                    <option value="tee-end">End ‚ä£</option>
                    <option value="tee-start">‚ä¢ Start</option>
                    <option value="tee-both">‚ä¢ Both ‚ä£</option>
                  </optgroup>
                  <optgroup label="Open Arrow">
                    <option value="open-end">End ‚ñ∑</option>
                    <option value="open-start">‚óÅ Start</option>
                    <option value="open-both">‚óÅ Both ‚ñ∑</option>
                  </optgroup>
                </select>
              </div>
            </div>

            <button class="btn secondary sm toolbar-clear-btn" id="toolbarClearBtn" style="display: none;">
              Clear Selection
            </button>
          </div>

          <div class="canvas-empty-state" id="canvasEmptyState">
            <p>Your board is empty</p>
            <p class="subtext">Add cards from the sidebar to get started</p>
          </div>
        </div>

        <!-- Map View -->
        <div class="map-container hidden" id="mapView">
          <div class="map-canvas" id="mapCanvas">
            <div class="map-image-wrapper" id="mapImageWrapper">
              <img class="map-image hidden" id="mapImage" src="" alt="Map" />
              <svg class="regions-layer" id="regionsLayer" xmlns="http://www.w3.org/2000/svg">
                <defs id="regionPatternDefs"></defs>
              </svg>
              <svg class="region-draw-layer hidden" id="regionDrawLayer" xmlns="http://www.w3.org/2000/svg"></svg>
              <div class="pins-layer" id="pinsLayer"></div>
            </div>
          </div>

          <!-- Measurement Line SVG -->
          <svg class="measurement-layer" id="measurementLayer">
            <line
              class="measurement-line"
              id="measurementLine"
              x1="0"
              y1="0"
              x2="0"
              y2="0"
            />
            <circle
              class="measurement-point"
              id="measurePointA"
              cx="0"
              cy="0"
              r="6"
            />
            <circle
              class="measurement-point"
              id="measurePointB"
              cx="0"
              cy="0"
              r="6"
            />
          </svg>

          <div class="zoom-controls">
            <button class="zoom-btn" id="mapZoomOutBtn">
              ‚àí
            </button>
            <span class="zoom-level" id="mapZoomLevel">100%</span>
            <button class="zoom-btn" id="mapZoomInBtn">
              +
            </button>
            <button class="zoom-btn" id="mapZoomFitBtn">
              ‚óª
            </button>
            <div class="zoom-divider"></div>
            <button class="zoom-btn" id="mapZoomWidthBtn">
              ‚Üî
            </button>
            <button
              class="zoom-btn"
              id="mapZoomHeightBtn"
             
            >
              ‚Üï
            </button>
            <button class="zoom-btn" id="mapZoomCenterBtn">
              ‚äï
            </button>
          </div>

          <div class="canvas-tools">
            <button
              class="tool-btn active"
              data-tool="map-select"
             
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path d="M4 4l16 8-8 2-2 8z" />
              </svg>
            </button>
            <button class="tool-btn" data-tool="map-pin">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M12 21c-4-4-8-7.5-8-12a8 8 0 1116 0c0 4.5-4 8-8 12z" />
                <circle cx="12" cy="9" r="3" />
              </svg>
            </button>
            <button
              class="tool-btn"
              data-tool="map-destination"
             
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="3" />
                <circle cx="12" cy="12" r="8" opacity="0.6" />
                <path d="M12 2v2M12 20v2M2 12h2M20 12h2" />
              </svg>
            </button>

            <button
              class="tool-btn"
              data-tool="map-measure"
             
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M2 12h20M12 2v20M6 8l-4 4 4 4M18 8l4 4-4 4" />
              </svg>
            </button>
            <button class="tool-btn" data-tool="map-path">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 17c3-6 6-12 9-8s6 6 9 0" stroke-linecap="round"/>
                <circle cx="3" cy="17" r="2" fill="currentColor"/>
                <circle cx="21" cy="9" r="2" fill="currentColor"/>
              </svg>
            </button>
            <button class="tool-btn" data-tool="map-pan">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"
                />
              </svg>
            </button>
            <button class="tool-btn" data-tool="map-region">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 5l5-3 8 2 5 4v8l-4 5-7 1-6-3-1-6z" fill="currentColor" fill-opacity="0.15"/>
                <path d="M3 5l5-3 8 2 5 4v8l-4 5-7 1-6-3-1-6z"/>
              </svg>
            </button>
          </div>

          <!-- Measurement Display -->
          <div class="measurement-display hidden" id="measurementDisplay">
            <span class="measurement-value" id="measurementValue">0 miles</span>
            <button class="btn secondary sm" id="clearMeasurement">
              Clear
            </button>
          </div>

          <div class="map-empty-state" id="mapEmptyState" onclick="createAndEditNewMap()">
            <div class="map-upload-icon">üó∫Ô∏è</div>
            <p>Click here to upload a map</p>
            <p class="subtext">
              Supports JPG, PNG, and other image formats
            </p>
          </div>
        </div>

        <!-- Write View -->
        <div class="write-container hidden" id="writeView">
          <div class="write-header">
            <div class="write-chapter-info">
              <input
                type="text"
                class="write-chapter-label-input"
                id="writeChapterLabel"
                value="Chapter 1"
              />
              <input
                type="text"
                class="write-chapter-title"
                id="writeChapterTitle"
                value="Your Writing"
              />
            </div>
            <div class="write-stats">
              <span class="word-count" id="wordCount">0 words</span>
              <span class="save-status" id="saveStatus">Saved</span>
            </div>
          </div>
          <div class="write-toolbar">
            <select class="toolbar-select sm" id="fontFamily">
              <optgroup label="Sans Serif">
                <option value="Inter, sans-serif">Inter</option>
                <option value="Poppins, sans-serif">Poppins</option>
                <option value="Montserrat, sans-serif">Montserrat</option>
                <option value="Raleway, sans-serif">Raleway</option>
                <option value="Oswald, sans-serif">Oswald</option>
                <option value="Arial, sans-serif">Arial</option>
              </optgroup>
              <optgroup label="Serif">
                <option value="Merriweather, serif">Merriweather</option>
                <option value="Lora, serif">Lora</option>
                <option value="'Playfair Display', serif">Playfair Display</option>
                <option value="Cinzel, serif">Cinzel</option>
                <option value="'Crimson Text', serif">Crimson Text</option>
                <option value="'EB Garamond', serif">EB Garamond</option>
                <option value="'Libre Baskerville', serif">Libre Baskerville</option>
                <option value="Spectral, serif">Spectral</option>
                <option value="Vollkorn, serif">Vollkorn</option>
                <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
                <option value="Alegreya, serif">Alegreya</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
              </optgroup>
              <optgroup label="Handwriting">
                <option value="'Dancing Script', cursive">Dancing Script</option>
                <option value="Satisfy, cursive">Satisfy</option>
                <option value="Caveat, cursive">Caveat</option>
                <option value="'Permanent Marker', cursive">Permanent Marker</option>
                <option value="'Special Elite', cursive">Special Elite</option>
                <option value="UnifrakturMaguntia, cursive">Blackletter</option>
              </optgroup>
              <optgroup label="Monospace">
                <option value="'Source Code Pro', monospace">Source Code Pro</option>
                <option value="'Roboto Mono', monospace">Roboto Mono</option>
                <option value="'Press Start 2P', monospace">Press Start 2P</option>
                <option value="VT323, monospace">VT323</option>
              </optgroup>
            </select>
            <select class="toolbar-select xs" id="fontSize">
              <option value="12">12</option>
              <option value="14">14</option>
              <option value="16" selected>16</option>
              <option value="18">18</option>
              <option value="20">20</option>
              <option value="24">24</option>
              <option value="28">28</option>
              <option value="32">32</option>
            </select>
            <div class="write-toolbar-divider"></div>
            <button class="write-tool-btn" data-command="bold"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6 4h8a4 4 0 0 1 2.7 7A4.5 4.5 0 0 1 15 20H6V4zm3 7h5a1.5 1.5 0 0 0 0-3H9v3zm0 3v3h6a1.5 1.5 0 0 0 0-3H9z"/></svg></button>
            <button class="write-tool-btn" data-command="italic"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M10 4h8v2h-2.8l-4.4 12H14v2H6v-2h2.8l4.4-12H10V4z"/></svg></button>
            <button class="write-tool-btn" data-command="underline"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M7 4v7a5 5 0 0 0 10 0V4h2v7a7 7 0 0 1-14 0V4h2zm-1 16h12v2H6v-2z"/></svg></button>
            <button class="write-tool-btn" data-command="strikeThrough"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 12h18v2H3v-2zm5-4h4V5h2v3h4v2H8V8zm2 8h4v3h-2v-3z"/></svg></button>
            <div class="write-toolbar-divider"></div>
            <button class="write-tool-btn" data-command="justifyLeft"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm0 4h12v2H3V8zm0 4h18v2H3v-2zm0 4h12v2H3v-2zm0 4h18v2H3v-2z"/></svg></button>
            <button class="write-tool-btn" data-command="justifyCenter"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm3 4h12v2H6V8zm-3 4h18v2H3v-2zm3 4h12v2H6v-2zm-3 4h18v2H3v-2z"/></svg></button>
            <button class="write-tool-btn" data-command="justifyRight"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm6 4h12v2H9V8zm-6 4h18v2H3v-2zm6 4h12v2H9v-2zm-6 4h18v2H3v-2z"/></svg></button>
            <button class="write-tool-btn" id="indentToggleBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm6 4h12v2H9V8zm-6 4h18v2H3v-2zm6 4h12v2H9v-2zm-6 4h18v2H3v-2z"/><path d="M3 7l4 2.5L3 12V7z"/></svg></button>
            <button class="write-tool-btn" id="justifyToggleBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm0 4h18v2H3V8zm0 4h18v2H3v-2zm0 4h18v2H3v-2zm0 4h18v2H3v-2z"/></svg></button>
            <div class="write-toolbar-divider"></div>
            <button class="write-tool-btn" data-command="h1"><span class="write-tool-text">H1</span></button>
            <button class="write-tool-btn" data-command="h2"><span class="write-tool-text">H2</span></button>
            <button class="write-tool-btn" data-command="h3"><span class="write-tool-text">H3</span></button>
            <div class="write-toolbar-divider"></div>
            <button class="write-tool-btn" data-command="blockquote"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M4 12.2V4h7v8.2c0 3.4-2.2 6.3-5.5 7.8l-1-2c2-1 3.5-2.7 3.5-5.8H4zm11 0V4h7v8.2c0 3.4-2.2 6.3-5.5 7.8l-1-2c2-1 3.5-2.7 3.5-5.8h-4z"/></svg></button>
            <button class="write-tool-btn" data-command="insertUnorderedList"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm4-2h13v2H8V4zM4 13.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zM8 11h13v2H8v-2zM4 21a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm4-2h13v2H8v-2z"/></svg></button>
            <button class="write-tool-btn" data-command="insertOrderedList"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h2v4H4V5H3V4zm5 0h13v2H8V4zM4 10h2l-2 2.5V14h3v-1H5.5L7.5 11V9H4v1zm4 1h13v2H8v-2zM3 17v1h1v.5H3V20h3v-1H5v-.5h1V17H3zm5 1h13v2H8v-2z"/></svg></button>
            <div class="write-toolbar-divider"></div>
            <input type="color" class="write-tool-color" id="textColor" value="#f5ede0" />
            <input type="color" class="write-tool-color" id="highlightColor" value="#d4a824" />
            <button class="write-tool-btn" id="clearFormattingBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
            <div class="write-toolbar-divider"></div>
            <button class="write-tool-btn" id="insertLinkBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.5.5l3-3a5 5 0 0 0-7-7l-1.7 1.7"/><path d="M14 11a5 5 0 0 0-7.5-.5l-3 3a5 5 0 0 0 7 7l1.7-1.7"/></svg></button>
            <button class="write-tool-btn" id="insertImageBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/><path d="M21 15l-5-5L5 21"/></svg></button>
            <button class="write-tool-btn" id="insertTableBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg></button>
            <button class="write-tool-btn" id="insertColumnsBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="18" rx="1"/><rect x="14" y="3" width="7" height="18" rx="1"/></svg></button>
            <button class="write-tool-btn" id="insertDiceBtn"><svg viewBox="0 0 24 24" width="14" height="14"><rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="9" cy="9" r="1.5" fill="currentColor"/><circle cx="15" cy="15" r="1.5" fill="currentColor"/></svg></button>
            <button class="write-tool-btn" id="insertWikiLinkBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C8 2 5 5 5 8.5c0 5.5 7 13.5 7 13.5s7-8 7-13.5C19 5 16 2 12 2z"/><circle cx="12" cy="8.5" r="2" fill="currentColor"/></svg></button>
            <div class="write-toolbar-divider"></div>
            <button class="write-tool-btn" id="thesaurusBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/><line x1="8" y1="7" x2="16" y2="7"/><line x1="8" y1="11" x2="14" y2="11"/></svg></button>
            <button class="write-tool-btn" id="exportWriteBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
          </div>
          <div class="write-editor-wrapper">
            <div
              class="write-editor"
              id="writeEditor"
              contenteditable="true"
            ></div>
          </div>
        </div>

        <!-- Timeline View -->
        <div class="timeline-container hidden" id="timelineView">
          <div class="tl-header">
            <div class="tl-header-info">
              <input type="text" class="tl-name-input" id="tlNameInput" value="Campaign Timeline" placeholder="Timeline name..." />
              <div class="tl-calendar-badge" id="tlCalendarBadge">Gregorian</div>
            </div>
            <div class="tl-header-controls">
              <div class="tl-view-modes">
                <button class="tl-mode-btn active" id="tlModeLanes">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="4" rx="1"/><rect x="2" y="10" width="20" height="4" rx="1"/><rect x="2" y="16" width="20" height="4" rx="1"/></svg>
                </button>
                <button class="tl-mode-btn" id="tlModeList">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="2" x2="12" y2="22"/><circle cx="12" cy="6" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="18" r="2"/></svg>
                </button>
                <button class="tl-mode-btn" id="tlModeCalGrid">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                </button>
                <button class="tl-mode-btn" id="tlModeChronicle">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="2" x2="12" y2="22"/><circle cx="12" cy="5" r="2" fill="currentColor"/><line x1="14" y1="5" x2="20" y2="5"/><circle cx="12" cy="12" r="2" fill="currentColor"/><line x1="4" y1="12" x2="10" y2="12"/><circle cx="12" cy="19" r="2" fill="currentColor"/><line x1="14" y1="19" x2="20" y2="19"/></svg>
                </button>
                <button class="tl-mode-btn" id="tlModeAge">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="8" r="3"/><circle cx="16" cy="8" r="3"/><path d="M3 22v-2a4 4 0 014-4h2"/><path d="M15 22v-2a4 4 0 014-4h0"/><line x1="3" y1="22" x2="21" y2="22"/></svg>
                </button>
                <button class="tl-mode-btn" id="tlModeRelmap">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="5" cy="5" r="2"/><circle cx="19" cy="5" r="2"/><circle cx="12" cy="19" r="2"/><line x1="7" y1="5" x2="17" y2="5"/><line x1="6" y1="7" x2="11" y2="17"/><line x1="18" y1="7" x2="13" y2="17"/></svg>
                </button>
                <button class="tl-mode-btn" id="tlModeGantt">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="8" height="3" rx="1"/><rect x="7" y="9" width="12" height="3" rx="1"/><rect x="5" y="14" width="6" height="3" rx="1"/><rect x="10" y="19" width="8" height="3" rx="1"/></svg>
                </button>
                <button class="tl-mode-btn" id="tlModeStoryboard">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="8" height="10" rx="1"/><rect x="14" y="2" width="8" height="6" rx="1"/><rect x="14" y="12" width="8" height="10" rx="1"/><rect x="2" y="16" width="8" height="6" rx="1"/></svg>
                </button>
              </div>
              <div class="tl-zoom-controls">
                <button class="icon-btn sm" id="tlZoomOut">‚àí</button>
                <span class="tl-zoom-label" id="tlZoomLabel">100%</span>
                <button class="icon-btn sm" id="tlZoomIn">+</button>
              </div>
              <button class="btn primary sm" id="addEventBtn">+ Event</button>
            </div>
          </div>
          <div class="tl-body" id="tlBody">
            <div class="tl-empty-state" id="tlEmptyState">
              <div class="tl-empty-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.4">
                  <line x1="12" y1="2" x2="12" y2="22" />
                  <circle cx="12" cy="6" r="2" /><circle cx="12" cy="12" r="2" /><circle cx="12" cy="18" r="2" />
                </svg>
              </div>
              <p>Create a timeline or select a calendar template to begin</p>
            </div>
            <!-- Lanes View (horizontal swim lanes, all timelines) -->
            <div class="tl-lanes-view" id="tlLanesView" style="display:none;">
              <div class="tl-lanes-scroll" id="tlLanesScroll">
                <div class="tl-ruler" id="tlRuler"></div>
                <div class="tl-lanes" id="tlLanes"></div>
              </div>
            </div>
            <!-- List View (vertical event list, single timeline) -->
            <div class="tl-list-view" id="tlListView" style="display:none;">
              <div class="tl-list-scroll" id="tlListScroll"></div>
            </div>
            <!-- Calendar Grid View (month grid with events) -->
            <div class="tl-calgrid-view" id="tlCalGridView" style="display:none;">
              <div class="tl-calgrid-header">
                <button class="icon-btn sm" id="calGridPrev">‚óÄ</button>
                <span class="tl-calgrid-title" id="calGridTitle">Month Year</span>
                <button class="icon-btn sm" id="calGridNext">‚ñ∂</button>
              </div>
              <div class="tl-calgrid-body" id="calGridBody"></div>
            </div>
            <div class="tl-chronicle-view" id="tlChronicleView" style="display:none;">
              <div class="tl-chronicle-scroll" id="tlChronicleScroll"></div>
            </div>
            <div class="tl-age-view" id="tlAgeView" style="display:none;">
              <div class="tl-age-content" id="tlAgeContent"></div>
            </div>
            <div class="tl-relmap-container" id="tlRelmapView" style="display:none;">
              <svg id="tlRelmapSvg" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;"></svg>
              <div id="tlRelmapNodes"></div>
            </div>
            <div class="tl-gantt-view" id="tlGanttView" style="display:none;">
              <div class="tl-gantt-scroll" id="tlGanttScroll"></div>
            </div>
            <div class="tl-storyboard-view" id="tlStoryboardView" style="display:none;">
              <div class="tl-storyboard-scroll" id="tlStoryboardScroll"></div>
            </div>
          </div>
        </div>

        <!-- Event Editor Modal -->
        <div class="popup-overlay hidden" id="eventEditorModal">
          <div class="popup-modal">
            <div class="popup-header">
              <h3 id="eventEditorTitle">Add Event</h3>
              <button class="icon-btn popup-close" onclick="closeEventEditor()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12" /></svg>
              </button>
            </div>
            <div class="popup-body">
              <label class="popup-label">Event Title</label>
              <input type="text" class="popup-input" id="eventTitle" placeholder="What happened..." />

              <label class="popup-label">Start Date</label>
              <div style="display:flex;gap:8px;">
                <div style="flex:1">
                  <input type="number" class="popup-input" id="eventDay" min="1" value="1" placeholder="Day" />
                </div>
                <div style="flex:2">
                  <select class="popup-input" id="eventMonth"></select>
                </div>
                <div style="flex:1">
                  <input type="number" class="popup-input" id="eventYear" value="1" placeholder="Year" />
                </div>
              </div>

              <div class="popup-toggle-row">
                <label class="popup-label" style="margin:0;">Date Range</label>
                <label class="tl-toggle"><input type="checkbox" id="eventRangeToggle" /><span class="tl-toggle-slider"></span></label>
              </div>
              <div id="eventEndDateRow" style="display:none;">
                <label class="popup-label">End Date</label>
                <div style="display:flex;gap:8px;">
                  <div style="flex:1">
                    <input type="number" class="popup-input" id="eventEndDay" min="1" value="1" placeholder="Day" />
                  </div>
                  <div style="flex:2">
                    <select class="popup-input" id="eventEndMonth"></select>
                  </div>
                  <div style="flex:1">
                    <input type="number" class="popup-input" id="eventEndYear" value="1" placeholder="Year" />
                  </div>
                </div>
              </div>

              <label class="popup-label">Description</label>
              <textarea class="popup-input popup-textarea" id="eventDesc" rows="3" placeholder="Details..."></textarea>

              <label class="popup-label">Color</label>
              <div class="pin-color-options" id="eventColorOptions">
                <button class="pin-color-btn active" data-color="#d4a824" style="background: #d4a824"></button>
                <button class="pin-color-btn" data-color="#f43f5e" style="background: #f43f5e"></button>
                <button class="pin-color-btn" data-color="#f97316" style="background: #f97316"></button>
                <button class="pin-color-btn" data-color="#22c55e" style="background: #22c55e"></button>
                <button class="pin-color-btn" data-color="#3b82f6" style="background: #3b82f6"></button>
                <button class="pin-color-btn" data-color="#8b5cf6" style="background: #8b5cf6"></button>
                <button class="pin-color-btn" data-color="#ec4899" style="background: #ec4899"></button>
                <button class="pin-color-btn" data-color="#14b8a6" style="background: #14b8a6"></button>
                <button class="pin-color-btn" data-color="#f5ede0" style="background: #f5ede0"></button>
              </div>

              <label class="popup-label">Tags</label>
              <input type="text" class="popup-input" id="eventTagsInput" placeholder="Type a tag, press comma or Enter..." />
              <div class="chapter-tags-display" id="eventTagsDisplay"></div>

              <label class="popup-label">Era <span style="font-weight:400;opacity:0.6">(optional)</span></label>
              <input type="text" class="popup-input" id="eventEra" placeholder="e.g. Age of Calamity, Chapter 3..." />
            </div>
            <div class="popup-actions">
              <button class="btn danger" id="deleteEventBtn" onclick="deleteCurrentEvent()" style="display:none">Delete</button>
              <button class="btn secondary" onclick="closeEventEditor()">Cancel</button>
              <button class="btn primary" onclick="saveEvent()">Save</button>
            </div>
          </div>
        </div>

        <!-- Set Date Modal -->
        <div class="popup-overlay hidden" id="setDateModal">
          <div class="popup-modal sm">
            <div class="popup-header">
              <h3>Set Current Date</h3>
              <button class="icon-btn popup-close" onclick="document.getElementById('setDateModal').classList.add('hidden')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12" /></svg>
              </button>
            </div>
            <div class="popup-body">
              <div style="display:flex;gap:8px;">
                <div style="flex:1">
                  <label class="popup-label">Day</label>
                  <input type="number" class="popup-input" id="setDateDay" min="1" value="1" />
                </div>
                <div style="flex:2">
                  <label class="popup-label">Month</label>
                  <select class="popup-input" id="setDateMonth"></select>
                </div>
                <div style="flex:1">
                  <label class="popup-label">Year</label>
                  <input type="number" class="popup-input" id="setDateYear" value="1" />
                </div>
              </div>
            </div>
            <div class="popup-actions">
              <button class="btn secondary" onclick="document.getElementById('setDateModal').classList.add('hidden')">Cancel</button>
              <button class="btn primary" onclick="applySetDate()">Set Date</button>
            </div>
          </div>
        </div>

        <!-- Custom Calendar Editor Modal -->
        <div class="popup-overlay hidden" id="calendarEditorModal">
          <div class="popup-modal lg">
            <div class="popup-header">
              <h3>Edit Calendar</h3>
              <button class="icon-btn popup-close" onclick="closeCalendarEditor()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12" /></svg>
              </button>
            </div>
            <div class="popup-body" style="max-height:60vh;overflow-y:auto;">
              <label class="popup-label">Year Label</label>
              <input type="text" class="popup-input" id="calYearLabel" placeholder="e.g. AD, DR, PD..." />

              <label class="popup-label">Era Name</label>
              <input type="text" class="popup-input" id="calEraName" placeholder="e.g. Dale Reckoning..." />

              <label class="popup-label">Weekday Names <span style="font-weight:400;opacity:0.6">(comma-separated)</span></label>
              <input type="text" class="popup-input" id="calWeekdays" placeholder="Mon, Tue, Wed..." />

              <label class="popup-label">Months</label>
              <div class="cal-months-editor" id="calMonthsEditor"></div>
              <button class="btn secondary sm" onclick="addCalendarMonth()" style="margin-top:6px;">+ Add Month</button>

              <label class="popup-label" style="margin-top:16px;">Moons</label>
              <div class="cal-moons-editor" id="calMoonsEditor"></div>
              <button class="btn secondary sm" onclick="addCalendarMoon()" style="margin-top:6px;">+ Add Moon</button>
            </div>
            <div class="popup-actions">
              <button class="btn secondary" onclick="closeCalendarEditor()">Cancel</button>
              <button class="btn primary" onclick="saveCalendarEdits()">Save Calendar</button>
            </div>
          </div>
        </div>

        <!-- Initiative Edit Popup -->
        <div class="popup-overlay hidden" id="initEditModal">
          <div class="popup-modal sm">
            <div class="popup-header">
              <h3>Set Initiative</h3>
              <button class="icon-btn popup-close" onclick="document.getElementById('initEditModal').classList.add('hidden')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
              </button>
            </div>
            <div class="popup-body">
              <label class="popup-label" id="initEditLabel">Initiative for ‚Äî</label>
              <input type="number" class="popup-input" id="initEditValue" placeholder="Initiative value..." />
            </div>
            <div class="popup-actions">
              <button class="btn secondary" onclick="document.getElementById('initEditModal').classList.add('hidden')">Cancel</button>
              <button class="btn primary" onclick="confirmInitEdit()">Set</button>
            </div>
          </div>
        </div>

        <!-- Faction Create Popup -->
        <div class="popup-overlay hidden" id="factionCreateModal">
          <div class="popup-modal">
            <div class="popup-header">
              <h3 id="factionCreateTitle">Create Faction</h3>
              <button class="icon-btn popup-close" onclick="closeFactionCreateModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
              </button>
            </div>
            <div class="popup-body">
              <label class="popup-label">Faction Name</label>
              <input type="text" class="popup-input" id="facCreateName" placeholder="Enter faction name..." />
              <label class="popup-label">Description <span style="font-weight:400;opacity:0.6">(optional)</span></label>
              <textarea class="popup-input" id="facCreateDesc" rows="2" placeholder="Brief description..." style="resize:vertical;min-height:48px;"></textarea>
              <label class="popup-label">Tier <span style="font-weight:400;opacity:0.6">(optional)</span></label>
              <select class="popup-input" id="facCreateTier">
                <option value="">‚Äî None ‚Äî</option>
                <option value="Tier 0 (Weak)">Tier 0 (Weak)</option>
                <option value="Tier I">Tier I</option>
                <option value="Tier II">Tier II</option>
                <option value="Tier III">Tier III</option>
                <option value="Tier IV">Tier IV</option>
                <option value="Tier V (Dominant)">Tier V (Dominant)</option>
                <option value="Tier VI (Legendary)">Tier VI (Legendary)</option>
              </select>
              <label class="popup-label">Status</label>
              <select class="popup-input" id="facCreateStatus">
                <option value="Neutral">Neutral</option>
                <option value="Allied">Allied</option>
                <option value="Friendly">Friendly</option>
                <option value="Suspicious">Suspicious</option>
                <option value="Hostile">Hostile</option>
                <option value="At War">At War</option>
              </select>
              <label class="popup-label">Color</label>
              <div class="popup-color-row" id="facCreateColors"></div>
            </div>
            <div class="popup-actions">
              <button class="btn secondary" onclick="closeFactionCreateModal()">Cancel</button>
              <button class="btn primary" onclick="confirmFactionCreate()">Create</button>
            </div>
          </div>
        </div>

        <!-- Contact Create Popup -->
        <div class="popup-overlay hidden" id="contactCreateModal">
          <div class="popup-modal">
            <div class="popup-header">
              <h3 id="contactCreateTitle">Add Contact</h3>
              <button class="icon-btn popup-close" onclick="closeContactCreateModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
              </button>
            </div>
            <div class="popup-body">
              <label class="popup-label">Name</label>
              <input type="text" class="popup-input" id="conCreateName" placeholder="Contact name..." />
              <label class="popup-label">Role <span style="font-weight:400;opacity:0.6">(optional)</span></label>
              <input type="text" class="popup-input" id="conCreateRole" placeholder="Role or title..." />
                            <label class="popup-label">Species <span style="font-weight:400;opacity:0.6">(optional)</span></label>
              <input type="text" class="popup-input" id="conCreateSpecies" placeholder="" />
              <label class="popup-label">Connected to <span style="font-weight:400;opacity:0.6">(optional)</span></label>
              <input type="text" class="popup-input" id="conCreateConnectedTo" placeholder="" />
<label class="popup-label">Faction <span style="font-weight:400;opacity:0.6">(optional)</span></label>
              <select class="popup-input" id="conCreateFaction"><option value="">‚Äî Independent ‚Äî</option></select>
              <label class="popup-label">Disposition</label>
              <select class="popup-input" id="conCreateDisp">
                <option value="Neutral">Neutral</option>
                <option value="Allied">Allied</option>
                <option value="Friendly">Friendly</option>
                <option value="Suspicious">Suspicious</option>
                <option value="Hostile">Hostile</option>
              </select>
              <label class="popup-label">Type</label>
              <input type="text" class="popup-input" id="conCreateType" placeholder="e.g. Contact, Informant, Patron..." value="Contact" />
              <label class="popup-label">Notes <span style="font-weight:400;opacity:0.6">(optional)</span></label>
              <textarea class="popup-input" id="conCreateNotes" rows="2" placeholder="Notes..." style="resize:vertical;min-height:36px;"></textarea>
            </div>
            <div class="popup-actions">
              <button class="btn secondary" onclick="closeContactCreateModal()">Cancel</button>
              <button class="btn primary" onclick="confirmContactCreate()">Add</button>
            </div>
          </div>
        </div>

        <!-- Claim Add Popup -->
        <div class="popup-overlay hidden" id="claimAddModal">
          <div class="popup-modal sm">
            <div class="popup-header">
              <h3>Add Claim / Holding</h3>
              <button class="icon-btn popup-close" onclick="document.getElementById('claimAddModal').classList.add('hidden')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
              </button>
            </div>
            <div class="popup-body">
              <input type="text" class="popup-input" id="claimAddInput" placeholder="Territory, asset, or holding..." />
            </div>
            <div class="popup-actions">
              <button class="btn secondary" onclick="document.getElementById('claimAddModal').classList.add('hidden')">Cancel</button>
              <button class="btn primary" onclick="confirmClaimAdd()">Add</button>
            </div>
          </div>
        </div>

        <!-- Global Search Overlay -->
        <div class="search-overlay hidden" id="searchOverlay">
          <div class="search-box">
            <div class="search-input-row">
              <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              <input type="text" class="search-input" id="searchInput" placeholder="Search cards, pins, chapters, timelines, factions, contacts, organizations..." autocomplete="off" />
              <kbd class="search-kbd">ESC</kbd>
            </div>
            <div class="search-results" id="searchResults">
              <div class="search-hint">Start typing to search across all your content...</div>
            </div>
          </div>
        </div>

        <!-- Settings Modal -->
        <div class="popup-overlay hidden" id="orgCreateModal">
          <div class="popup-modal">
            <div class="popup-header">
              <h3>New Organization</h3>
              <button class="icon-btn popup-close" onclick="document.getElementById('orgCreateModal').classList.add('hidden')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>
            <div class="popup-body">
              <label class="popup-label">Name</label>
              <input type="text" class="popup-input" id="orgCreateName" placeholder="Organization name..." />
              <label class="popup-label">Type</label>
              <input type="text" class="popup-input" id="orgCreateType" placeholder="e.g. Guild, Church, Company, Military..." value="" />
              <label class="popup-label">Location</label>
              <input type="text" class="popup-input" id="orgCreateLocation" placeholder="Where is it based?" />
              <label class="popup-label">Leader</label>
              <input type="text" class="popup-input" id="orgCreateLeader" placeholder="Who leads it?" />
              <div style="margin-top:6px;">
                <label class="popup-label" style="margin-bottom:4px;">Color</label>
                <div class="swatch-picker" id="orgCreateColorSwatches"></div>
              </div>
            </div>
            <div class="popup-actions">
              <button class="btn secondary" onclick="document.getElementById('orgCreateModal').classList.add('hidden')">Cancel</button>
              <button class="btn primary" onclick="confirmCreateOrg()">Create</button>
            </div>
          </div>
        </div>

        <!-- Settings Modal -->
        <div class="popup-overlay hidden" id="settingsModal">
          <div class="popup-modal" style="max-width:360px;">
            <div class="popup-header">
              <h3>View Settings</h3>
              <button class="icon-btn popup-close" onclick="closeSettingsModal()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>
            <div class="popup-body" style="padding:12px 16px;">
              <p style="font-size:11px;color:var(--text-muted);margin-bottom:12px;">Toggle which views are visible in the navigation.</p>
              <div class="settings-checks" id="settingsChecks"></div>
            </div>
            <div class="popup-actions">
              <button class="btn primary" onclick="closeSettingsModal()">Done</button>
            </div>
          </div>
        </div>

        <!-- Encounter Save Popup -->
        <div class="popup-overlay hidden" id="encounterSaveModal">
          <div class="popup-modal" style="max-width:340px;">
            <div class="popup-header">
              <h3>Save Encounter</h3>
              <button class="icon-btn popup-close" onclick="document.getElementById('encounterSaveModal').classList.add('hidden')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>
            <div class="popup-body" style="padding:12px 16px;">
              <label class="popup-label">Encounter Name</label>
              <input type="text" class="popup-input" id="encounterSaveName" placeholder="e.g. Goblin Ambush..." />
              <label style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-secondary);margin-top:8px;cursor:pointer;">
                <input type="checkbox" id="encounterClearAfterSave" style="accent-color:var(--gold);" /> Clear tracker after saving
              </label>
            </div>
            <div class="popup-actions">
              <button class="btn secondary" onclick="document.getElementById('encounterSaveModal').classList.add('hidden')">Cancel</button>
              <button class="btn primary" onclick="confirmSaveEncounter()">Save</button>
            </div>
          </div>
        </div>

        <!-- Combatant Context Menu -->
        <div class="popup-overlay hidden" id="combatClearModal">
          <div class="popup-modal" style="max-width:380px;">
            <div class="popup-header">
              <h3>Clear Encounter</h3>
              <button class="icon-btn popup-close" onclick="document.getElementById('combatClearModal').classList.add('hidden')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
              </button>
            </div>
            <div class="popup-body">
              <p style="color:var(--text-secondary);margin-bottom:16px;">Are you sure you want to clear all combatants from the encounter? This cannot be undone.</p>
              <div class="popup-actions">
                <button class="btn secondary" onclick="document.getElementById('combatClearModal').classList.add('hidden')">Cancel</button>
                <button class="btn primary" style="background:#f43f5e;" onclick="confirmClearEncounter()">Clear Encounter</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Combatant Context Menu -->
        <div class="context-menu hidden" id="combatantContextMenu">
          <div class="context-menu-item" data-action="dupCombatant">Duplicate</div>
          <div class="context-menu-item" data-action="dupCombatant3">Duplicate √ó3</div>
          <div class="context-menu-item" data-action="dupCombatant5">Duplicate √ó5</div>
          <div class="context-menu-divider"></div>
          <div class="context-menu-item owner-only" data-action="toggleHideCombatant">Toggle Hidden</div>
          <div class="context-menu-divider"></div>
          <div class="context-menu-item danger" data-action="delCombatant">Delete</div>
        </div>

        <!-- Region Context Menu -->
        <div class="context-menu hidden" id="regionContextMenu">
          <div class="context-menu-item" onclick="editSelectedRegion()">Edit Region</div>
          <div class="context-menu-item" onclick="duplicateSelectedRegion()">Duplicate</div>
          <div class="context-menu-item owner-only" onclick="toggleHideRegionCtx()">Toggle Hidden</div>
          <div class="context-menu-divider"></div>
          <div class="context-menu-item danger" onclick="deleteSelectedRegion()">Delete Region</div>
        </div>

        <!-- Faction/Contact Context Menu -->
        <div class="context-menu hidden" id="facContactContextMenu">
          <div class="context-menu-item" data-action="dupFacItem">Duplicate</div>
          <div class="context-menu-item owner-only" data-action="toggleHideFacItem">Toggle Hidden</div>
          <div class="context-menu-divider"></div>
          <div class="context-menu-item danger" data-action="delFacItem">Delete</div>
        </div>

        <!-- Chapter Context Menu -->
        <div class="context-menu hidden" id="chapterContextMenu">
          <div class="context-menu-item" onclick="moveChapterToFolderCtx(null)">Remove from Folder</div>
          <div class="context-menu-item owner-only" onclick="toggleHideChapterCtx()">Toggle Hidden</div>
          <div class="context-menu-divider"></div>
          <div class="context-menu-item danger" onclick="deleteChapterCtx()">Delete Chapter</div>
        </div>

        <!-- Folder Context Menu -->
        <div class="context-menu hidden" id="folderContextMenu">
          <div class="context-menu-item" onclick="toggleHideFolderCtx()">Toggle Hidden</div>
          <div class="context-menu-divider"></div>
          <div class="context-menu-item danger" onclick="deleteChapterFolderCtx()">Delete Folder</div>
        </div>

        <!-- Board Context Menu -->
        <div class="context-menu hidden" id="boardContextMenu">
          <div class="context-menu-item" onclick="duplicateBoardCtx()">Duplicate Board</div>
          <div class="context-menu-item" onclick="renameBoardCtx()">Rename Board</div>
          <div class="context-menu-divider"></div>
          <div class="context-menu-item danger" onclick="deleteBoardCtx()">Delete Board</div>
        </div>

        <!-- Timeline Context Menu -->
        <div class="context-menu hidden" id="tlContextMenu">
          <div class="context-menu-item" onclick="duplicateTimelineCtx()">Duplicate Timeline</div>
          <div class="context-menu-item" onclick="editCalendarCtx()">Edit Calendar</div>
          <div class="context-menu-item" onclick="setTlImageCtx()">Set Image</div>
          <div class="context-menu-divider"></div>
          <div class="context-menu-item owner-only" onclick="toggleHideTimelineCtx()">Toggle Hidden</div>
          <div class="context-menu-divider"></div>
          <div class="context-menu-item danger" onclick="deleteTimelineCtx()">Delete Timeline</div>
        </div>

        <!-- Event Context Menu -->
        <div class="context-menu hidden" id="evtContextMenu">
          <div class="context-menu-item" onclick="editEventCtx()">Edit Event</div>
          <div class="context-menu-item" onclick="duplicateEventCtx()">Duplicate Event</div>
          <div class="context-menu-item" onclick="moveEventToCurrentDateCtx()">Move to Current Date</div>
          <div class="context-menu-divider"></div>
          <div class="context-menu-item owner-only" onclick="toggleHideEventCtx()">Toggle Hidden</div>
          <div class="context-menu-divider"></div>
          <div class="context-menu-item danger" onclick="deleteEventCtx()">Delete Event</div>
        </div>

        <!-- Combat View -->
        <div class="combat-container hidden" id="combatView">
          <div class="ct-view-header">
            <div class="ct-view-header-left">
              <span class="ct-round-badge" id="ctRoundBadge">Not Started</span>
            </div>
            <div class="ct-view-header-right">
              <button class="ct-btn sm" id="ctRollAllInit">üé≤ Roll All</button>
              <button class="ct-btn sm" id="ctSortInit">‚áÖ Sort</button>
              <button class="ct-btn sm" id="ctResetCombat">‚Ü∫ Reset</button>
            </div>
          </div>
          <!-- Tracker View -->
          <div class="ct-view-body" id="ctTrackerView">
            <div class="ct-turn-bar" id="ctTurnBar">
              <button class="ct-turn-nav" id="ctPrevTurn">‚óÄ</button>
              <div class="ct-turn-current" id="ctTurnCurrent">
                <span class="ct-turn-label">Start combat to begin tracking</span>
              </div>
              <button class="ct-turn-nav" id="ctNextTurn">‚ñ∂ Next</button>
            </div>
            <div class="ct-main-grid" id="ctMainGrid">
              <div class="ct-combatants-col">
                <div class="ct-combatants" id="ctCombatantsList">
                  <div class="ct-empty"><p>No combatants</p><p style="opacity:0.5;font-size:11px;">Add creatures from the sidebar to begin</p></div>
                </div>
              </div>
              <div class="ct-detail-col hidden" id="ctDetailCol">
                <div class="ct-detail-card" id="ctDetailCard">
                  <div class="ct-detail-name" id="ctDetailName">‚Äî</div>
                  <div class="ct-image-section" id="ctImageSection">
                    <div class="ct-image-preview" id="ctImagePreview">
                      <span style="font-size:11px;color:var(--text-muted);cursor:pointer;" onclick="document.getElementById('ctImageUpload').click()">+ Add Image</span>
                    </div>
                    <input type="file" id="ctImageUpload" accept="image/*" style="display:none" onchange="handleCombatantImageUpload(event)" />
                  </div>
                  <div class="ct-harm-section">
                    <label class="ct-detail-label">Health</label>
                    <div class="ct-harm-bar-lg" id="ctHarmBarLg">
                      <div class="ct-harm-fill-lg" id="ctHarmFillLg"></div>
                    </div>
                    <div class="ct-harm-numbers" id="ctHarmNumbers">‚Äî / ‚Äî</div>
                    <div class="ct-harm-controls">
                      <button class="ct-btn sm" onclick="ctDamage(1)">-1</button>
                      <button class="ct-btn sm" onclick="ctDamage(5)">-5</button>
                      <button class="ct-btn sm" onclick="ctDamage(10)">-10</button>
                      <button class="ct-btn sm" onclick="ctHeal(1)">+1</button>
                      <button class="ct-btn sm" onclick="ctHeal(5)">+5</button>
                      <button class="ct-btn sm" onclick="ctHeal(10)">+10</button>
                    </div>
                  </div>
                  <div class="ct-conditions-section">
                    <label class="ct-detail-label">Conditions</label>
                    <div class="ct-conditions-grid" id="ctConditionsGrid"></div>
                  </div>
                  <div class="ct-buffs-section">
                    <label class="ct-detail-label">Buffs & Debuffs</label>
                    <div class="ct-buffs-list" id="ctBuffsList"></div>
                    <div class="ct-buff-add">
                      <input type="text" class="ct-add-input" id="ctBuffInput" placeholder="Add buff/debuff..." />
                      <select class="ct-add-input sm" id="ctBuffType" style="width:80px;"><option value="buff">Buff</option><option value="debuff">Debuff</option></select>
                      <button class="ct-btn sm" onclick="addBuff()">+</button>
                    </div>
                  </div>
                  <div class="ct-notes-section">
                    <label class="ct-detail-label">Hidden GM Notes</label>
                    <textarea class="ct-notes-area" id="ctNotesArea" placeholder="Private notes about this combatant..."></textarea>
                  </div>
                </div>
              </div>
              <!-- Resize handle between columns -->
              <div class="ct-resize-handle" id="ctResizeHandle"></div>
            </div>
          </div>
        </div>

        <!-- Factions View -->
        <div class="faction-container hidden" id="factionView">
          <div class="fac-header">
            <div class="fac-sub-tabs">
              <button class="fac-sub-tab active" id="facTabFactions" onclick="switchFacTab('factions')">Factions</button>
              <button class="fac-sub-tab" id="facTabContacts" onclick="switchFacTab('contacts')">Contacts</button>
              <button class="fac-sub-tab" id="facTabOrgs" onclick="switchFacTab('orgs')">Organizations</button>
            </div>
          </div>
          <!-- Factions Grid -->
          <div class="fac-body" id="facBody">
            <div class="fac-grid" id="facGrid">
              <div class="fac-empty"><p>No factions yet</p><p style="opacity:0.5;font-size:12px;">Create factions from the sidebar to begin tracking</p></div>
            </div>
          </div>
          <!-- Contacts Grid -->
          <div class="fac-body hidden" id="facContactsBody">
            <div class="fac-contacts-grid" id="facContactsGrid">
              <div class="fac-empty"><p>No contacts yet</p><p style="opacity:0.5;font-size:12px;">Add contacts from the sidebar</p></div>
            </div>
          </div>
          <!-- Organizations Grid -->
          <div class="fac-body hidden" id="facOrgsBody">
            <div class="fac-grid" id="facOrgsGrid">
              <div class="fac-empty"><p>No organizations yet</p><p style="opacity:0.5;font-size:12px;">Add organizations from the sidebar to track guilds, companies, churches, etc.</p></div>
            </div>
          </div>
        </div>

        <!-- Mind Map View -->
        <div class="mindmap-container hidden" id="mindmapView">
          <div class="mindmap-toolbar">
            <button class="btn secondary sm" id="mmResetLayout">‚Üª Reset</button>
            <button class="btn secondary sm" id="mmShakeBtn">üé≤ Shake</button>
            <button class="btn secondary sm" id="mmZoomFit">‚óª Fit</button>
          </div>
          <svg class="mindmap-canvas" id="mindmapCanvas">
            <g id="mindmapEdges"></g>
            <g id="mindmapNodes"></g>
          </svg>
        </div>

        <!-- Soundscape View -->
        <div class="soundboard-container hidden" id="soundboardView">
          <div class="sb-layout">
            <div class="sb-sidebar">
              <div class="sb-sidebar-section">
                <div class="sb-sidebar-header">
                  <span>Soundscapes</span>
                  <button class="sb-sidebar-add" id="sbScapeSave">+</button>
                </div>
                <div class="sb-sidebar-list" id="sbScapeList">
                  <div class="sb-sidebar-empty">No saved soundscapes</div>
                </div>
              </div>
              <div class="sb-sidebar-section">
                <div class="sb-sidebar-header">
                  <span>Playlists</span>
                  <button class="sb-sidebar-add" id="sbPlaylistAdd">+</button>
                </div>
                <div class="sb-sidebar-list" id="sbPlaylistList">
                  <div class="sb-sidebar-empty">No playlists yet</div>
                </div>
              </div>
            </div>
            <div class="sb-main">
              <div class="sb-master">
                <div class="sb-master-left">
                  <button class="sb-master-btn sb-play" id="sbPlayAll">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5,3 19,12 5,21"/></svg>
                  </button>
                  <button class="sb-master-btn sb-stop" id="sbStopAll">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                  </button>
                  <div class="sb-master-vol">
                    <span class="sb-master-vol-label">Master</span>
                    <input type="range" id="sbMasterVol" min="0" max="100" value="70" />
                    <span id="sbMasterVolVal" class="sb-master-vol-val">70%</span>
                  </div>
                  <div class="sb-master-vol sb-personal-vol">
                    <span class="sb-master-vol-label">My Vol</span>
                    <input type="range" id="sbPersonalVol" min="0" max="100" value="100" />
                    <span id="sbPersonalVolVal" class="sb-master-vol-val">100%</span>
                  </div>
                </div>
                <div class="sb-master-right">
                  <button class="sb-master-btn sb-browse-btn" id="sbBrowseBtn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    Browse
                  </button>
                  <button class="sb-master-btn" id="sbUploadBtn">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                  </button>
                  <button class="sb-master-btn" id="sbYoutubeBtn">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22.54 6.42a2.78 2.78 0 00-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 00-1.94 2A29 29 0 001 12a29 29 0 00.46 5.58 2.78 2.78 0 001.94 2c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 001.94-2A29 29 0 0023 12a29 29 0 00-.46-5.58z"/><polygon points="9.75 15.02 15.5 12 9.75 8.98"/></svg>
                  </button>
                  <button class="sb-master-btn" id="sbMvConnectBtn">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    My Playlists
                  </button>
                </div>
              </div>
              <div class="sb-categories" id="sbCategories">
                <button class="sb-cat-btn active" data-cat="all">All</button>
                <button class="sb-cat-btn" data-cat="tavern">Tavern & Inn</button>
                <button class="sb-cat-btn" data-cat="dungeon">Dungeon & Cave</button>
                <button class="sb-cat-btn" data-cat="forest">Forest & Wild</button>
                <button class="sb-cat-btn" data-cat="town">Town & Village</button>
                <button class="sb-cat-btn" data-cat="combat">Battle & Combat</button>
                <button class="sb-cat-btn" data-cat="ocean">Ocean & Water</button>
                <button class="sb-cat-btn" data-cat="castle">Castle & Ruins</button>
                <button class="sb-cat-btn" data-cat="tense">Tense</button>
                <button class="sb-cat-btn" data-cat="peaceful">Peaceful</button>
                <button class="sb-cat-btn" data-cat="mysterious">Mysterious</button>
                <button class="sb-cat-btn" data-cat="epic">Epic</button>
                <button class="sb-cat-btn" data-cat="dark">Dark</button>
                <button class="sb-cat-btn" data-cat="custom">Custom</button>
              </div>
              <div class="sb-channels" id="sbChannels"></div>
            </div>
          </div>
          <input type="file" id="sbFileInput" accept="audio/*" multiple style="display:none" />
        </div>

        <!-- Hidden image input for timeline images -->
        <input type="file" id="tlImageInput" accept="image/*" style="display:none" />

        <!-- Right Details Panel -->
        <aside class="details-panel" id="detailsPanel">
          <div class="panel-header">
            <span class="panel-title">Details</span>
            <button class="icon-btn close-btn" id="closePanelBtn">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>

          <div class="panel-body" id="panelBody">
            

            <div class="chapter-details hidden" id="chapterDetails">
              <div class="detail-section">
                <label class="detail-label">Chapter</label>
                <div class="chapter-detail-name" id="chapterDetailName">-</div>
              
<div class="empty-state" id="emptyState">
              <p>Select a card to view details</p>
            </div>

            <div class="card-details hidden" id="cardDetails">
              <div class="detail-image-preview hidden" id="detailImagePreview">
                <img id="detailImage" src="" alt="Card image" />
                <button class="remove-image-btn" id="removeImageBtn">√ó</button>
              </div>

              <div class="detail-section">
                <label class="detail-label">Name</label>
                <input
                  type="text"
                  class="detail-input"
                  id="detailName"
                  placeholder="Card name..."
                />
              </div>

              <!-- Card Style Section -->
              <div class="detail-section card-style-section">
                <label class="detail-label">Card Style</label>
                <div class="style-row">
                  <select class="detail-select sm" id="cardFontFamily">
                    <option value="Inter">Inter</option>
                    <option value="Poppins">Poppins</option>
                    <option value="Montserrat">Montserrat</option>
                    <option value="Raleway">Raleway</option>
                    <option value="Oswald">Oswald</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Merriweather">Merriweather</option>
                    <option value="Lora">Lora</option>
                    <option value="Playfair Display">Playfair Display</option>
                    <option value="Cinzel">Cinzel</option>
                    <option value="Crimson Text">Crimson Text</option>
                    <option value="EB Garamond">EB Garamond</option>
                    <option value="Libre Baskerville">Libre Baskerville</option>
                    <option value="Spectral">Spectral</option>
                    <option value="Vollkorn">Vollkorn</option>
                    <option value="Cormorant Garamond">Cormorant Garamond</option>
                    <option value="Alegreya">Alegreya</option>
                    <option value="Dancing Script">Dancing Script</option>
                    <option value="Satisfy">Satisfy</option>
                    <option value="Caveat">Caveat</option>
                    <option value="Permanent Marker">Permanent Marker</option>
                    <option value="Special Elite">Special Elite</option>
                    <option value="UnifrakturMaguntia">Blackletter</option>
                    <option value="Source Code Pro">Source Code Pro</option>
                    <option value="Roboto Mono">Roboto Mono</option>
                    <option value="Press Start 2P">Press Start 2P</option>
                    <option value="VT323">VT323</option>
                    <option value="monospace">Monospace</option>
                  </select>
                  <select class="detail-select sm" id="cardFontSize">
                    <option value="10">10px</option>
                    <option value="11">11px</option>
                    <option value="12">12px</option>
                    <option value="13">13px</option>
                    <option value="14" selected>14px</option>
                    <option value="16">16px</option>
                    <option value="18">18px</option>
                    <option value="20">20px</option>
                    <option value="24">24px</option>
                    <option value="28">28px</option>
                    <option value="32">32px</option>
                  </select>
                </div>
                <div class="style-row" style="margin-top:6px;">
                  <div class="toolbar-control-group" style="flex:1">
                    <label style="font-size:9px;color:var(--text-muted)">Label</label>
                    <input type="color" class="detail-color-sm" id="detailLabelColor" value="#4ecdc4" />
                  </div>
                  <div class="toolbar-control-group" style="flex:1">
                    <label style="font-size:9px;color:var(--text-muted)">Text</label>
                    <input type="color" class="detail-color-sm" id="detailTextColor" value="#a89880" />
                  </div>
                  <div class="toolbar-control-group" style="flex:1">
                    <label style="font-size:9px;color:var(--text-muted)">Title</label>
                    <input type="color" class="detail-color-sm" id="detailTitleColor" value="#f5ede0" />
                  </div>
                </div>
              </div>
              <div
                class="detail-section text-align-section hidden"
                id="textAlignSection"
              >
                <label class="detail-label">Alignment</label>
                <div class="align-buttons">
                  <button
                    class="align-btn active"
                    data-align="left"
                   
                  >
                    ‚¨±
                  </button>
                  <button class="align-btn" data-align="center">
                    ‚ò∞
                  </button>
                  <button class="align-btn" data-align="right">
                    ‚¨±
                  </button>
                  <button class="align-btn" data-align="justify">
                    ‚â°
                  </button>
                </div>
              </div>

              <!-- Dynamic Type Fields -->
              <div class="detail-section hidden" id="typeFieldsSection"></div>

              <div
                class="detail-section standard-description"
                id="standardDescSection"
              >
                <label class="detail-label">Description</label>
                <textarea
                  class="detail-textarea"
                  id="detailDescription"
                  placeholder="Add description..."
                ></textarea>
              </div>

              <!-- Stat Block Section -->
              <div
                class="detail-section statblock-section hidden"
                id="statblockSection"
              >
                <label class="detail-label">Stats</label>
                <div class="stat-grid" id="statGrid"></div>
                <button class="add-btn-full" id="addStatBtn">+ Add Stat</button>
              </div>

              <!-- Chart Section -->
              <div
                class="detail-section chart-section hidden"
                id="chartSection"
              >
                <label class="detail-label">Chart Settings</label>
                <div class="chart-type-select">
                  <label>Type</label>
                  <select class="detail-select" id="chartType">
                    <option value="pie">Pie Chart</option>
                    <option value="donut">Donut</option>
                    <option value="gauge">Gauge</option>
                    <option value="ring">Ring</option>
                  </select>
                </div>
                <div class="chart-fill-select">
                  <label>Segment Style</label>
                  <select class="detail-select" id="chartFill">
                    <option value="solid">Solid</option>
                    <option value="striped">Striped</option>
                    <option value="crosshatch">Crosshatch</option>
                    <option value="dots">Dots</option>
                    <option value="gradient">Gradient</option>
                    <option value="outline">Outline Only</option>
                  </select>
                </div>
                <label class="detail-label" style="margin-top: 12px"
                  >Segments</label
                >
                <div class="chart-data-list" id="chartDataList"></div>
                <button class="add-btn-full" id="addChartDataBtn">
                  + Add Segment
                </button>
              </div>

              <!-- Bar Card Section -->
              <div class="detail-section bar-section hidden" id="barSection">
                <label class="detail-label">Bars</label>
                <div class="bars-list" id="barsList"></div>
                <button class="add-btn-full" id="addBarBtn">+ Add Bar</button>
              </div>

              <!-- Stress/Clock Section -->
              <div
                class="detail-section stress-section hidden"
                id="stressSection"
              >
                <label class="detail-label">Clock Settings</label>
                <div class="stress-settings">
                  <div class="setting-row">
                    <label>Segments</label>
                    <input
                      type="number"
                      id="stressSegments"
                      value="4"
                      min="2"
                      max="12"
                    />
                  </div>
                  <div class="setting-row">
                    <label>Filled</label>
                    <input type="number" id="stressFilled" value="0" min="0" />
                  </div>
                  <div class="setting-row">
                    <label>Style</label>
                    <select id="stressStyle">
                      <option value="clock">Clock</option>
                      <option value="boxes">Boxes</option>
                      <option value="diamonds">Diamonds</option>
                      <option value="circles">Circles</option>
                      <option value="slashes">Slashes</option>
                    </select>
                  </div>
                  <div class="setting-row">
                    <label>Fill Pattern</label>
                    <select id="stressFillStyle">
                      <option value="solid">Solid</option>
                      <option value="striped">Striped</option>
                      <option value="gradient">Gradient</option>
                      <option value="outline">Outline</option>
                      <option value="crosshatch">Crosshatch</option>
                      <option value="dots">Dots</option>
                      <option value="glow">Glow</option>
                      <option value="diamond-pattern">Diamond Pattern</option>
                    </select>
                  </div>
                  <div class="setting-row">
                    <label>Color</label>
                    <input type="color" id="stressColor" value="#f97316" />
                  </div>
                </div>
              </div>

              <!-- Injury Track Section -->
              <div
                class="detail-section injury-section hidden"
                id="injurySection"
              >
                <label class="detail-label">Injury Tracks</label>
                <div class="injury-tracks-list" id="injuryTracksList"></div>
                <button class="add-btn-full" id="addInjuryTrackBtn">
                  + Add Track
                </button>
              </div>

              <!-- Body Map Section -->
              <div class="detail-section body-section hidden" id="bodySection">
                <label class="detail-label">Body Settings</label>
                <div class="body-settings">
                  <div class="setting-row">
                    <label>Figure</label>
                    <select id="bodyFigure">
                      <option value="neutral">Neutral</option>
                      <option value="masculine">Masculine</option>
                      <option value="feminine">Feminine</option>
                    </select>
                  </div>
                  <div class="setting-row">
                    <label>Overlay Color</label>
                    <input type="color" id="bodyOverlayColor" value="#000000" />
                  </div>
                  <div class="setting-row">
                    <label>Point Color</label>
                    <input type="color" id="pointColor" value="#ef4444" />
                  </div>

                </div>
                <p class="setting-hint">
                  Click on the body map to add/remove injury points
                </p>
              </div>

              <!-- Text Style Section -->
              <div
                class="detail-section text-style-section hidden"
                id="textStyleSection"
              >
                <label class="detail-label">Text Style</label>
                <select class="detail-select" id="textStyleSelect">
                  <option value="heading1">Heading 1</option>
                  <option value="heading2">Heading 2</option>
                  <option value="heading3">Heading 3</option>
                  <option value="body">Body Text</option>
                  <option value="caption">Caption</option>
                </select>
              </div>

              <!-- Item Card Section -->
              <div class="detail-section item-section hidden" id="itemSection">
                <label class="detail-label">Item Properties</label>
                <div class="setting-row">
                  <label>Type</label>
                  <select class="detail-select" id="itemType">
                    <option value="weapon">Weapon</option>
                    <option value="armor">Armor</option>
                    <option value="consumable">Consumable</option>
                    <option value="tool">Tool</option>
                    <option value="artifact">Artifact</option>
                    <option value="gear">Gear</option>
                    <option value="misc">Miscellaneous</option>
                  </select>
                </div>
                <div class="setting-row">
                  <label>Rarity</label>
                  <select class="detail-select" id="itemRarity">
                    <option value="common">Common</option>
                    <option value="uncommon">Uncommon</option>
                    <option value="rare">Rare</option>
                    <option value="epic">Epic</option>
                    <option value="legendary">Legendary</option>
                  </select>
                </div>
                <div class="setting-row">
                  <label>Load</label>
                  <select class="detail-select" id="itemLoad">
                    <option value="0">‚Äî</option>
                    <option value="1">1 (Light)</option>
                    <option value="2">2 (Normal)</option>
                    <option value="3">3 (Heavy)</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                  </select>
                </div>
                <div class="setting-row">
                  <label>Uses</label>
                  <div style="display:flex;gap:4px;align-items:center;">
                    <input type="number" class="detail-input sm" id="itemUsesCurrent" min="0" value="0" style="width:50px">
                    <span style="color:var(--text-muted)">/</span>
                    <input type="number" class="detail-input sm" id="itemUsesMax" min="0" value="0" style="width:50px">
                  </div>
                </div>
                <label class="detail-label" style="margin-top:8px">Effect</label>
                <textarea class="detail-textarea" id="itemEffect" placeholder="Damage, healing, special abilities..." rows="2"></textarea>
                <label class="detail-label" style="margin-top:8px">Properties</label>
                <div class="item-properties-list" id="itemPropertiesList"></div>
                <button class="add-btn-full" id="addItemPropertyBtn">+ Add Property</button>
              </div>

              <!-- Personality Section -->
              <div class="detail-section personality-section hidden" id="personalitySection">
                <label class="detail-label">Personality Traits</label>
                <div class="personality-traits-list" id="personalityTraitsList"></div>
                <button class="add-btn-full" id="addPersonalityTraitBtn">+ Add Trait</button>
              </div>

              <!-- Attributes Section -->
              <div class="detail-section attributes-section hidden" id="attributesSection">
                <label class="detail-label">Category</label>
                <select class="detail-select" id="attrCategory">
                  <option value="appearance">Appearance</option>
                  <option value="background">Background</option>
                  <option value="demeanor">Demeanor</option>
                  <option value="custom">Custom</option>
                </select>
                <label class="detail-label" style="margin-top:8px">Traits</label>
                <div class="attributes-list" id="attributesList"></div>
                <button class="add-btn-full" id="addAttributeBtn">+ Add Trait</button>
              </div>

              <!-- Inventory Section -->
              <div class="detail-section inventory-section hidden" id="inventorySection">
                <label class="detail-label">Max Slots / Load</label>
                <input type="number" class="detail-input sm" id="invMaxSlots" value="10" min="1" max="100">
                <label class="detail-label" style="margin-top:8px">Items</label>
                <div class="inventory-items-list" id="inventoryItemsList"></div>
                <button class="add-btn-full" id="addInventoryItemBtn">+ Add Item</button>
              </div>

              <!-- Currency Section -->
              <div class="detail-section currency-section hidden" id="currencySection">
                <label class="detail-label">Currencies</label>
                <div class="currency-list" id="currencyList"></div>
                <button class="add-btn-full" id="addCurrencyBtn">+ Add Currency</button>
                <label class="detail-label" style="margin-top:8px">Stash</label>
                <div class="stash-list" id="stashList"></div>
                <button class="add-btn-full" id="addStashBtn">+ Add Stash</button>
              </div>

              <!-- Mood Section -->
              <div class="detail-section mood-section hidden" id="moodSection">
                <label class="detail-label">Mood Level</label>
                <input type="range" id="moodLevel" min="0" max="100" value="50" class="mood-slider-input">
                <div class="setting-row">
                  <label>Low Label</label>
                  <input type="text" class="detail-input sm" id="moodLowLabel" value="Despair" placeholder="Low end...">
                </div>
                <div class="setting-row">
                  <label>High Label</label>
                  <input type="text" class="detail-input sm" id="moodHighLabel" value="Euphoria" placeholder="High end...">
                </div>
                <div class="setting-row">
                  <label>Color Low</label>
                  <input type="color" class="detail-color" id="moodColorLow" value="#ef4444">
                </div>
                <div class="setting-row">
                  <label>Color High</label>
                  <input type="color" class="detail-color" id="moodColorHigh" value="#22c55e">
                </div>
              </div>

              <div class="detail-section randomizer-section hidden" id="randomizerSection">
                <label class="detail-label">Dice Notation <span style="font-weight:400;opacity:0.6">(optional)</span></label>
                <input type="text" class="detail-input sm" id="randDiceNotation" placeholder="e.g. 1d6, 2d10..." />
                <label class="detail-label" style="margin-top:8px;">Table Entries</label>
                <div id="randEntriesList"></div>
                <button class="btn secondary sm" id="randAddEntry" style="margin-top:6px;">+ Add Entry</button>
                <div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border-color);">
                  <button class="rand-roll-btn-detail" id="randRollBtn">üé≤ Roll</button>
                  <div class="rand-detail-result" id="randLastResult"></div>
                </div>
              </div>

              <div class="detail-section hidden" id="abilitySection">
                <label class="detail-label">Ability Type</label>
                <select class="detail-input" id="abilityType">
                  <option value="spell">Spell</option>
                  <option value="skill">Skill</option>
                  <option value="feat">Feat</option>
                  <option value="ability">Ability</option>
                </select>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px;">
                  <div><label class="detail-label" style="font-size:10px;">Level</label><input type="text" class="detail-input sm" id="abilityLevel" placeholder="e.g. 3" /></div>
                  <div><label class="detail-label" style="font-size:10px;">Cost</label><input type="text" class="detail-input sm" id="abilityCost" placeholder="e.g. 2 SP" /></div>
                  <div><label class="detail-label" style="font-size:10px;">Range</label><input type="text" class="detail-input sm" id="abilityRange" placeholder="e.g. 60ft" /></div>
                  <div><label class="detail-label" style="font-size:10px;">Duration</label><input type="text" class="detail-input sm" id="abilityDuration" placeholder="e.g. 1 min" /></div>
                </div>
                <label class="detail-label" style="margin-top:8px;">Description</label>
                <textarea class="detail-textarea" id="abilityDesc" rows="3" placeholder="What does this ability do?"></textarea>
                <label class="detail-label" style="margin-top:8px;">Tracking</label>
                <select class="detail-input" id="abilityUseType">
                  <option value="ticks">Tick Boxes</option>
                  <option value="counter">Counter</option>
                  <option value="none">None</option>
                </select>
                <div style="margin-top:4px;">
                  <label class="detail-label" style="font-size:10px;">Max Uses</label>
                  <input type="number" class="detail-input sm" id="abilityMaxUses" value="3" min="1" max="20" />
                </div>
              </div>

              <div class="detail-section">
                <label class="detail-label">Tags</label>
                <input
                  type="text"
                  class="detail-input"
                  id="detailTags"
                  placeholder="tag1, tag2, tag3..."
                />
              </div>
              <div class="detail-section">
                <label class="detail-label">Connections</label>
                <div class="connections-list" id="connectionsList"></div>
                <button class="add-connection-btn" id="addConnectionBtn">
                  + Add Connection
                </button>
              </div>

              <div class="detail-section">
                <label class="detail-label">Associations</label>
                <div class="search-input-wrapper">
                  <input
                    type="text"
                    class="detail-input"
                    id="cardAssociationSearch"
                    placeholder="Search cards, pins, chapters..."
                    autocomplete="off"
                  />
                  <div
                    class="search-results hidden"
                    id="cardAssociationSearchResults"
                  ></div>
                </div>
                <div class="associations-list" id="cardAssociationsList"></div>
              </div>

              <div
                class="detail-section image-upload-section hidden"
                id="imageUploadSection"
              >
                <label class="detail-label">Card Image</label>
                <button class="btn secondary full-width" id="uploadImageBtn">
                  Upload Image
                </button>
              </div>

              <div class="detail-section">
                <button class="btn danger full-width" id="deleteCardBtn">
                  Delete Card
                </button>
              </div>
            </div>

            <!-- Pin Details (Map View) -->
            <div class="pin-details hidden" id="pinDetails">
              <div class="detail-section">
                <label class="detail-label">Pin Name</label>
                <div class="pin-detail-name" id="pinDetailName">-</div>
              </div>
              <div class="detail-section">
                <label class="detail-label">Description</label>
                <div class="pin-detail-description" id="pinDetailDescription">
                  -
                </div>
              </div>
              <div class="detail-section" id="pinTagsSection">
                <label class="detail-label">Tags</label>
                <div class="pin-detail-tags" id="pinDetailTags"></div>
              </div>
              <div class="detail-section" id="pinAssociationsSection">
                <label class="detail-label">Associations</label>
                <div class="pin-detail-associations" id="pinDetailAssociations">
                  <span class="no-associations">None</span>
                </div>
              </div>
              <div class="detail-section">
                <button class="btn secondary full-width" id="editPinBtn">
                  Edit Pin
                </button>
              </div>
            </div>

            <!-- Chapter Details (Write View) -->

            <!-- Region Details (Map View) -->
            <div class="region-details hidden" id="regionDetails">
              <div class="detail-section">
                <label class="detail-label">Region Name</label>
                <input class="detail-input" id="regionDetailName" placeholder="Unnamed Region" />
              </div>
              <div class="detail-section">
                <label class="detail-label">Label</label>
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
                  <div class="swatch-picker" id="regionTextColorSwatches"></div>
                  <label style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text-muted);cursor:pointer;white-space:nowrap;">
                    <input type="checkbox" id="regionHideText" style="accent-color:var(--gold);" />
                    Hide
                  </label>
                </div>
              </div>
              <div class="detail-section">
                <label class="detail-label">Fill</label>
                <div class="swatch-picker" id="regionFillColorSwatches"></div>
                <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
                  <label class="detail-label" style="margin:0;font-size:11px;white-space:nowrap;">Opacity</label>
                  <input type="range" class="mm-slider" id="regionFillOpacity" min="0" max="0.8" step="0.05" value="0.2" style="flex:1;" />
                </div>
              </div>
              <div class="detail-section">
                <label class="detail-label">Fill Pattern</label>
                <select class="detail-input" id="regionFillPattern">
                  <option value="solid">Solid</option>
                  <option value="stripes">Stripes</option>
                  <option value="dots">Dots</option>
                  <option value="crosshatch">Crosshatch</option>
                  <option value="none">None (outline only)</option>
                </select>
              </div>
              <div class="detail-section">
                <label class="detail-label">Stroke</label>
                <div class="swatch-picker" id="regionStrokeColorSwatches"></div>
              </div>
              <div class="detail-section">
                <label class="detail-label">Stroke Width</label>
                <input type="range" class="mm-slider" id="regionStrokeWidth" min="1" max="8" step="0.5" value="2" style="width:100%;" />
              </div>
              <div class="detail-section">
                <label class="detail-label">Stroke Style</label>
                <select class="detail-input" id="regionStrokeStyle">
                  <option value="solid">Solid</option>
                  <option value="dashed">Dashed</option>
                  <option value="dotted">Dotted</option>
                  <option value="none">None</option>
                </select>
              </div>
              <div class="detail-section">
                <label class="detail-label">Tags</label>
                <div id="regionDetailTagsDisplay" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;"></div>
                <input class="detail-input" id="regionDetailTagsInput" placeholder="Add tag..." />
              </div>
              <div class="detail-section">
                <label class="detail-label">Points</label>
                <div class="region-points-list" id="regionPointsList"></div>
              </div>
              <div class="detail-section" style="padding-top:8px;">
                <button class="btn danger sm" id="regionDeleteBtn" style="width:100%;">Delete Region</button>
              </div>
            </div>

            <!-- Map Path Details -->
            <div class="map-path-detail hidden" id="mapPathDetails">
              <div class="detail-section">
                <label class="detail-label">Path Name</label>
                <input class="detail-input" id="pathDetailName" placeholder="Unnamed Path" />
              </div>
              <div class="detail-section">
                <label class="detail-label">Color</label>
                <div class="swatch-picker" id="pathColorSwatches"></div>
              </div>
              <div class="detail-section">
                <label class="detail-label">Width</label>
                <input type="range" class="mm-slider" id="pathDetailWidth" min="1" max="8" step="0.5" value="2" style="width:100%;" />
              </div>
              <div class="detail-section">
                <label class="detail-label">Style</label>
                <select class="detail-input" id="pathDetailStyle">
                  <option value="solid">Solid</option>
                  <option value="dashed">Dashed</option>
                  <option value="dotted">Dotted</option>
                  <option value="dashdot">Dash-Dot</option>
                </select>
              </div>
              <div class="detail-group">
                <label class="detail-label">Endpoints</label>
                <select class="detail-input" id="pathDetailArrow">
                  <option value="none">None</option>
                  <option value="end">Arrow End ‚Üí</option>
                  <option value="start">‚Üê Arrow Start</option>
                  <option value="both">‚Üê Both ‚Üí</option>
                  <option value="dots">‚óè Dots ‚óè</option>
                </select>
              </div>
              <div class="detail-section">
                <label class="detail-label">Curve Type</label>
                <select class="detail-input" id="pathDetailCurve">
                  <option value="smooth">Smooth (Auto)</option>
                  <option value="straight">Straight Lines</option>
                  <option value="step">Step (L-Shape)</option>
                </select>
              </div>
              <div class="detail-section">
                <label class="detail-label">Curve Tension <span id="pathTensionVal" style="float:right;opacity:0.5;font-size:10px">0.33</span></label>
                <input type="range" class="mm-slider" id="pathDetailTension" min="0" max="1" step="0.05" value="0.33" style="width:100%;" />
              </div>
              <div class="detail-section" style="padding-top:8px;">
                <button class="btn danger sm" id="pathDeleteBtn" style="width:100%;">Delete Path</button>
              </div>
            </div></div>
              <div class="detail-section">
                <label class="detail-label">Tags</label>
                <input
                  type="text"
                  class="detail-input"
                  id="chapterTags"
                  placeholder="Type a tag and press comma or Enter..."
                />
                <div class="chapter-tags-display" id="chapterTagsDisplay"></div>
              </div>
              <div class="detail-section">
                <label class="detail-label">Associations</label>
                <div class="search-input-wrapper">
                  <input
                    type="text"
                    class="detail-input"
                    id="chapterAssociationSearch"
                    placeholder="Search cards, pins..."
                    autocomplete="off"
                  />
                  <div
                    class="search-results hidden"
                    id="chapterAssociationSearchResults"
                  ></div>
                </div>
                <div
                  class="associations-list"
                  id="chapterAssociationsList"
                ></div>
              </div>
            </div>

            <!-- Timeline Details (Timeline View - selected timeline) -->
            <div class="tl-details hidden" id="tlDetails">
              <div class="detail-section">
                <label class="detail-label">Timeline</label>
                <input type="text" class="detail-input" id="tlDetailName" placeholder="Timeline name..." />
              </div>
              <div class="detail-section">
                <label class="detail-label">Calendar</label>
                <div style="display:flex;align-items:center;gap:8px;">
                  <div class="tl-calendar-badge" id="tlDetailCalBadge" style="font-size:10px;"></div>
                  <button class="btn secondary sm" onclick="openCalendarEditor()">Edit</button>
                </div>
              </div>
              <div class="detail-section">
                <label class="detail-label">Color</label>
                <div class="pin-color-options" id="tlDetailColorOptions">
                  <button class="pin-color-btn" data-color="#3b82f6" style="background:#3b82f6"></button>
                  <button class="pin-color-btn" data-color="#f43f5e" style="background:#f43f5e"></button>
                  <button class="pin-color-btn" data-color="#22c55e" style="background:#22c55e"></button>
                  <button class="pin-color-btn" data-color="#f97316" style="background:#f97316"></button>
                  <button class="pin-color-btn" data-color="#8b5cf6" style="background:#8b5cf6"></button>
                  <button class="pin-color-btn" data-color="#14b8a6" style="background:#14b8a6"></button>
                  <button class="pin-color-btn" data-color="#eab308" style="background:#eab308"></button>
                  <button class="pin-color-btn" data-color="#ec4899" style="background:#ec4899"></button>
                  <button class="pin-color-btn" data-color="#d4a824" style="background:#d4a824"></button>
                </div>
              </div>
              <div class="detail-section">
                <label class="detail-label">Image</label>
                <div class="tl-detail-image-preview" id="tlDetailImagePreview">
                  <div class="empty-pins-message" id="tlDetailNoImage">No image set</div>
                  <img id="tlDetailImage" src="" alt="" style="display:none;width:100%;border-radius:var(--radius-sm);margin-bottom:6px;" />
                </div>
                <div style="display:flex;gap:6px;">
                  <button class="btn secondary sm" onclick="document.getElementById('tlImageInput').click()">Choose Image</button>
                  <button class="btn secondary sm" id="tlRemoveImageBtn" onclick="removeTlImage()" style="display:none">Remove</button>
                </div>
              </div>
              <div class="detail-section">
                <label class="detail-label">Tags</label>
                <input type="text" class="detail-input" id="tlDetailTagsInput" placeholder="Type tag, press comma..." />
                <div class="chapter-tags-display" id="tlDetailTagsDisplay"></div>
              </div>
            </div>

            <!-- Faction Details -->
            <div class="faction-details hidden" id="factionDetails">
              <div class="fac-detail-color-bar" id="facDetailColorBar"></div>
              <div class="detail-section">
                <label class="detail-label">Image</label>
                <div class="fac-detail-image-wrap" id="facDetailImageWrap">
                  <div class="fac-detail-no-image" id="facDetailNoImage">No image</div>
                  <img id="facDetailImage" src="" alt="" class="fac-detail-img hidden" />
                </div>
                <div style="display:flex;gap:6px;margin-top:4px;">
                  <button class="btn secondary sm" id="facDetailUploadBtn">Choose Image</button>
                  <button class="btn secondary sm hidden" id="facDetailRemoveImg" style="color:#f43f5e;">Remove</button>
                </div>
                <input type="file" id="facImageInput" accept="image/*" style="display:none" />
              </div>
              <div class="detail-section">
                <label class="detail-label">Name</label>
                <input type="text" class="detail-input" id="facDetailName" placeholder="Faction name..." />
              </div>
              <div class="detail-section">
                <label class="detail-label">Tier</label>
                <select class="detail-input" id="facDetailTier">
                  <option value="">‚Äî No Tier ‚Äî</option>
                  <option value="Tier 0 (Weak)">Tier 0 (Weak)</option>
                  <option value="Tier I">Tier I</option>
                  <option value="Tier II">Tier II</option>
                  <option value="Tier III">Tier III</option>
                  <option value="Tier IV">Tier IV</option>
                  <option value="Tier V (Dominant)">Tier V (Dominant)</option>
                  <option value="Tier VI (Legendary)">Tier VI (Legendary)</option>
                </select>
              </div>
              <div class="detail-section">
                <label class="detail-label">Status</label>
                <select class="detail-input" id="facDetailStatus">
                  <option value="Allied">Allied</option>
                  <option value="Friendly">Friendly</option>
                  <option value="Neutral">Neutral</option>
                  <option value="Suspicious">Suspicious</option>
                  <option value="Hostile">Hostile</option>
                  <option value="At War">At War</option>
                </select>
              </div>
              <div class="detail-section">
                <label class="detail-label">Reputation</label>
                <div class="fac-rep-track" id="facDetailRepTrack"></div>
                <div class="fac-rep-label" id="facDetailRepLabel"></div>
              </div>
              <div class="detail-section">
                <label class="detail-label">Description</label>
                <textarea class="detail-input" id="facDetailDesc" rows="3" style="resize:vertical;" placeholder="Description..."></textarea>
              </div>
              <div class="detail-section">
                <label class="detail-label">Tags</label>
                <div class="chapter-tags-display" id="facDetailTagsDisplay"></div>
                <input type="text" class="detail-input" id="facDetailTagsInput" placeholder="Type tag, press comma..." />
              </div>
              <div class="detail-section">
                <label class="detail-label">Associations</label>
                <div class="search-input-wrapper">
                  <input type="text" class="detail-input" id="facAssociationSearch" placeholder="Search cards, pins, factions..." autocomplete="off" />
                  <div class="search-results hidden" id="facAssociationSearchResults"></div>
                </div>
                <div class="associations-list" id="facDetailAssocList"></div>
              </div>
              <div class="detail-section">
                <label class="detail-label">Claims & Holdings</label>
                <div class="fac-claims-list" id="facDetailClaimsList"></div>
                <button class="btn secondary sm" id="facDetailAddClaim" style="margin-top:4px;">+ Add Claim</button>
              </div>
              <div class="detail-section">
                <label class="detail-label">Connections</label>
                <div id="facDetailConnections"></div>
              </div>
              <div class="detail-section">
                <label class="detail-label">GM Notes</label>
                <textarea class="detail-input" id="facDetailNotes" rows="4" style="resize:vertical;" placeholder="Private notes..."></textarea>
              </div>
              <div class="detail-section" style="padding-top:8px;border-top:1px solid var(--border-color);">
                <button class="btn secondary sm" id="facDetailDelete" style="color:#f43f5e;">Delete Faction</button>
              </div>
            </div>

            <!-- Contact Details -->
            <div class="contact-details hidden" id="contactDetails">
              <div class="detail-section">
                <label class="detail-label">Image</label>
                <div class="fac-detail-image-wrap" id="conDetailImageWrap">
                  <div class="fac-detail-no-image" id="conDetailNoImage">No image</div>
                  <img id="conDetailImage" src="" alt="" class="fac-detail-img hidden" />
                </div>
                <div style="display:flex;gap:6px;margin-top:4px;">
                  <button class="btn secondary sm" id="conDetailUploadBtn">Choose Image</button>
                  <button class="btn secondary sm hidden" id="conDetailRemoveImg" style="color:#f43f5e;">Remove</button>
                </div>
                <input type="file" id="conImageInput" accept="image/*" style="display:none" />
              </div>
              <div class="detail-section">
                <label class="detail-label">Name</label>
                <input type="text" class="detail-input" id="conDetailName" placeholder="Contact name..." />
              </div>
              <div class="detail-section">
                <label class="detail-label">Role</label>
                <input type="text" class="detail-input" id="conDetailRole" placeholder="Title or role..." />
              </div>
              <div class="detail-section">
                <label class="detail-label">Faction</label>
                <select class="detail-input" id="conDetailFaction"></select>
              </div>
              <div class="detail-section">
                <label class="detail-label">Disposition</label>
                <select class="detail-input" id="conDetailDisp">
                  <option value="Allied">Allied</option>
                  <option value="Friendly">Friendly</option>
                  <option value="Neutral">Neutral</option>
                  <option value="Suspicious">Suspicious</option>
                  <option value="Hostile">Hostile</option>
                </select>
              </div>
              <div class="detail-section">
                <label class="detail-label">Type</label>
                <input type="text" class="detail-input" id="conDetailType" placeholder="e.g. Informant, Patron, Spy..." />
              </div>
              <div class="detail-section">
                <label class="detail-label">Species</label>
                <input type="text" class="detail-input" id="conDetailSpecies" placeholder="" />
              </div>
              <div class="detail-section">
                <label class="detail-label">Connected to</label>
                <input type="text" class="detail-input" id="conDetailConnectedTo" placeholder="" />
              </div>

              <div class="detail-section">
                <label class="detail-label">Description</label>
                <textarea class="detail-input" id="conDetailDesc" rows="3" style="resize:vertical;" placeholder="Description..."></textarea>
              </div>
              <div class="detail-section">
                <label class="detail-label">Tags</label>
                <div class="chapter-tags-display" id="conDetailTagsDisplay"></div>
                <input type="text" class="detail-input" id="conDetailTagsInput" placeholder="Type tag, press comma..." />
              </div>
              <div class="detail-section">
                <label class="detail-label">Associations</label>
                <div class="search-input-wrapper">
                  <input type="text" class="detail-input" id="conAssociationSearch" placeholder="Search cards, pins, factions..." autocomplete="off" />
                  <div class="search-results hidden" id="conAssociationSearchResults"></div>
                </div>
                <div class="associations-list" id="conDetailAssocList"></div>
              </div>
              <div class="detail-section">
                <label class="detail-label">Notes</label>
                <textarea class="detail-input" id="conDetailNotes" rows="4" style="resize:vertical;" placeholder="Notes..."></textarea>
              </div>
              <div class="detail-section" style="padding-top:8px;border-top:1px solid var(--border-color);">
                <button class="btn secondary sm" id="conDetailDelete" style="color:#f43f5e;">Delete Contact</button>
              </div>
            </div>

            <!-- Organization Details -->
            <div class="faction-details hidden" id="orgDetails">
              <div class="detail-section">
                <label class="detail-label">Image</label>
                <div class="fac-detail-image-wrap" id="orgDetailImageWrap">
                  <div class="fac-detail-no-image" id="orgDetailNoImage">No image</div>
                  <img id="orgDetailImage" src="" alt="" class="fac-detail-img hidden" />
                </div>
                <input type="file" id="orgImageUpload" accept="image/*" style="display:none" />
                <button class="btn secondary sm" id="orgImageBtn" style="margin-top:4px;">Upload Image</button>
              </div>
              <div class="detail-section">
                <label class="detail-label">Name</label>
                <input type="text" class="detail-input" id="orgDetailName" />
              </div>
              <div class="detail-section">
                <label class="detail-label">Type</label>
                <input type="text" class="detail-input" id="orgDetailType" placeholder="e.g. Guild, Church, Company..." />
              </div>
              <div class="detail-section">
                <label class="detail-label">Leader</label>
                <input type="text" class="detail-input" id="orgDetailLeader" placeholder="Who leads this?" />
              </div>
              <div class="detail-section">
                <label class="detail-label">Location</label>
                <input type="text" class="detail-input" id="orgDetailLocation" placeholder="Where is it based?" />
              </div>
              <div class="detail-section">
                <label class="detail-label">Status</label>
                <select class="detail-input" id="orgDetailStatus">
                  <option value="Active">Active</option>
                  <option value="Inactive">Inactive</option>
                  <option value="Dissolved">Dissolved</option>
                  <option value="Secret">Secret</option>
                  <option value="Rising">Rising</option>
                  <option value="Declining">Declining</option>
                </select>
              </div>
              <div class="detail-section">
                <label class="detail-label">Influence</label>
                <select class="detail-input" id="orgDetailInfluence">
                  <option value="Local">Local</option>
                  <option value="Regional">Regional</option>
                  <option value="National">National</option>
                  <option value="Continental">Continental</option>
                  <option value="Global">Global</option>
                </select>
              </div>
              <div class="detail-section">
                <label class="detail-label">Description</label>
                <textarea class="detail-textarea" id="orgDetailDesc" rows="3" placeholder="What does this organization do?"></textarea>
              </div>
              <div class="detail-section">
                <label class="detail-label">Goals & Motives</label>
                <textarea class="detail-textarea" id="orgDetailGoals" rows="2" placeholder="What are they trying to achieve?"></textarea>
              </div>
              <div class="detail-section">
                <label class="detail-label">Resources & Assets</label>
                <textarea class="detail-textarea" id="orgDetailResources" rows="2" placeholder="Wealth, soldiers, political power..."></textarea>
              </div>
              <div class="detail-section">
                <label class="detail-label">GM Notes</label>
                <textarea class="detail-textarea" id="orgDetailNotes" rows="2" placeholder="Private notes..."></textarea>
              </div>
              <div class="detail-section">
                <label class="detail-label">Color</label>
                <div class="swatch-picker" id="orgDetailColorSwatches"></div>
              </div>
              <div class="detail-section">
                <label class="detail-label">Tags</label>
                <div class="chapter-tags-display" id="orgDetailTagsDisplay"></div>
                <input type="text" class="detail-input" id="orgDetailTagsInput" placeholder="Type tag, press comma..." />
              </div>
              <div class="detail-section">
                <label class="detail-label">Associations</label>
                <div class="search-input-wrapper">
                  <input type="text" class="detail-input" id="orgAssociationSearch" placeholder="Search cards, pins, factions..." autocomplete="off" />
                  <div class="search-results hidden" id="orgAssociationSearchResults"></div>
                </div>
                <div class="associations-list" id="orgDetailAssocList"></div>
              </div>
              <div class="detail-section" style="padding-top:8px;border-top:1px solid var(--border-color);">
                <button class="btn secondary sm" id="orgDetailDelete" style="color:#f43f5e;">Delete Organization</button>
              </div>
            </div>

            <!-- Mind Map Details -->
            <div class="mindmap-details hidden" id="mindmapDetails">
              <div class="detail-section">
                <h3 class="mm-detail-tag-name" id="mmDetailTagName" style="color:var(--gold);margin:0 0 8px;font-size:16px;"></h3>
                <span class="mm-detail-count" id="mmDetailCount" style="font-size:11px;color:var(--text-muted);"></span>
              </div>
              <div class="detail-section">
                <label class="detail-label">Hex Color</label>
                <div class="swatch-picker" id="mmHexColorSwatches"></div>
              </div>
              <div class="detail-section">
                <label class="detail-label">Items with this tag</label>
                <div class="mm-items-list" id="mmItemsList"></div>
              </div>
            </div>

            <!-- Mind Map Physics Settings (always visible in mindmap view) -->
            <div class="mindmap-settings hidden" id="mindmapSettings">
              <div class="detail-section">
                <label class="detail-label" style="color:var(--gold);font-size:13px;">‚öô Physics</label>
                <div class="mm-slider-row">
                  <span class="mm-slider-label">Repulsion</span>
                  <input type="range" class="mm-slider" id="mmRepulsion" min="500" max="20000" value="5000" step="100" />
                </div>
                <div class="mm-slider-row">
                  <span class="mm-slider-label">Attraction</span>
                  <input type="range" class="mm-slider" id="mmAttraction" min="0.001" max="0.03" value="0.008" step="0.001" />
                </div>
                <div class="mm-slider-row">
                  <span class="mm-slider-label">Damping</span>
                  <input type="range" class="mm-slider" id="mmDamping" min="0.5" max="0.98" value="0.85" step="0.01" />
                </div>
                <div class="mm-slider-row">
                  <span class="mm-slider-label">Gravity</span>
                  <input type="range" class="mm-slider" id="mmGravity" min="0" max="0.01" value="0.002" step="0.0005" />
                </div>
                <div class="mm-slider-row">
                  <span class="mm-slider-label">Link Dist</span>
                  <input type="range" class="mm-slider" id="mmLinkDist" min="60" max="400" value="160" step="10" />
                </div>
              </div>
            </div>

            <!-- Timeline Calendar Panel -->
            <div class="tl-calendar-panel hidden" id="tlCalendarPanel">
              <div class="tl-cal-header">
                <button class="icon-btn sm" id="tlCalPrev">‚óÄ</button>
                <span class="tl-cal-title" id="tlCalTitle">Month Year</span>
                <button class="icon-btn sm" id="tlCalNext">‚ñ∂</button>
              </div>
              <div class="tl-cal-grid" id="tlCalGrid"></div>
              <div class="tl-cal-moon" id="tlCalMoon"></div>
              <div class="tl-cal-events" id="tlCalEvents">
                <label class="detail-label" style="margin-top:12px;">Events on Selected Day</label>
                <div class="tl-cal-event-list" id="tlCalEventList">
                  <div class="empty-pins-message">Click a day to see events</div>
                </div>
              </div>
              <div class="tl-event-detail hidden" id="tlEventDetail">
                <div class="tl-evt-color-bar" id="tlEvtColorBar"></div>
                <div class="tl-evt-title" id="tlEvtTitle"></div>
                <div class="tl-evt-date-label" id="tlEvtDateLabel"></div>
                <div class="tl-evt-desc" id="tlEvtDesc"></div>
                <div class="tl-evt-era" id="tlEvtEra"></div>
                <div class="tl-evt-tags" id="tlEvtTags"></div>
                <div style="margin-top:12px;display:flex;gap:6px;">
                  <button class="btn secondary sm" onclick="openEventEditor(selectedEventId)">Edit</button>
                  <button class="btn danger sm" onclick="deleteSelectedEvent()">Delete</button>
                </div>
              </div>
            </div>
          </div>
        </aside>
      </div>

      <!-- Connected Users Section (matches video room) -->
      <div id="craftConnectedBar" class="craft-connected-section" style="display:none"></div>
    </div>

    <!-- Guest join modal (injected by craft-app.js) -->
    <div id="craftGuestModal"></div>

    <!-- Settings modal (injected by craft-app.js) -->
    <div id="craftSettingsModal"></div>

    <script>
    window.APP_CONFIG = { API_BASE: "/api" };
    window.CRAFT_SYNC_INTERVAL = 500;
  </script>
  <script src="craft-app.js"></script>
  <script src="craft-script.js"></script>
    <!-- Multiview DM Screen Overlay -->
    <div class="multiview-overlay hidden" id="multiviewOverlay">
      <div class="multiview-header">
        <div class="multiview-title">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="2" width="9" height="9" rx="1"/><rect x="13" y="2" width="9" height="9" rx="1"/>
            <rect x="2" y="13" width="9" height="9" rx="1"/><rect x="13" y="13" width="9" height="9" rx="1"/>
          </svg>
          DM Screen
        </div>
                <div class="multiview-layout-btns">
          <button class="mv-layout-btn active" data-layout="2x2">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="9" height="9"/><rect x="13" y="2" width="9" height="9"/>
              <rect x="2" y="13" width="9" height="9"/><rect x="13" y="13" width="9" height="9"/>
            </svg>
          </button>
          <button class="mv-layout-btn" data-layout="2col">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="9" height="20"/><rect x="13" y="2" width="9" height="20"/>
            </svg>
          </button>
          <button class="mv-layout-btn" data-layout="3col">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="2" width="6" height="20"/><rect x="9" y="2" width="6" height="20"/><rect x="17" y="2" width="6" height="20"/>
            </svg>
          </button>
          <button class="mv-layout-btn" data-layout="1plus2">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="12" height="20"/><rect x="16" y="2" width="6" height="9"/><rect x="16" y="13" width="6" height="9"/>
            </svg>
          </button>
          <button class="mv-layout-btn" data-layout="focus">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="14" height="14"/><rect x="18" y="2" width="4" height="4.5"/><rect x="18" y="8.5" width="4" height="4.5"/><rect x="18" y="15" width="4" height="4.5"/>
              <rect x="2" y="18" width="14" height="4"/>
            </svg>
          </button>
          <button class="mv-layout-btn" data-layout="rows">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="20" height="9"/><rect x="2" y="13" width="20" height="9"/>
            </svg>
          </button>
          <button class="mv-layout-btn" data-layout="3rows">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="1" width="20" height="6"/><rect x="2" y="9" width="20" height="6"/><rect x="2" y="17" width="20" height="6"/>
            </svg>
          </button>
          <button class="mv-layout-btn" data-layout="1plus3">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="12" height="20"/><rect x="16" y="2" width="6" height="6"/><rect x="16" y="9.5" width="6" height="6"/><rect x="16" y="16" width="6" height="6"/>
            </svg>
          </button>
          <button class="mv-layout-btn" data-layout="topbar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="20" height="6"/><rect x="2" y="10" width="9" height="12"/><rect x="13" y="10" width="9" height="12"/>
            </svg>
          </button>
        </div>
        <button class="mv-close-btn" id="multiviewClose">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="multiview-grid" id="multiviewGrid" data-layout="2x2">
        <div class="mv-panel" data-panel="0">
          <div class="mv-panel-header">
            <select class="mv-panel-select">
              <option value="">Select View...</option>
              <option value="board">Board</option><option value="map">Map</option><option value="write">Writing</option>
              <option value="timeline">Timeline</option><option value="combat">Combat</option><option value="factions">Connections</option>
              <option value="mindmap">Mind Map</option><option value="soundboard">Soundscape</option>
              <option value="dice_log">Dice Log</option><option value="notes">Notes</option>
            </select>
          </div>
          <div class="mv-panel-content">
            <div class="mv-panel-nav hidden"></div>
            <div class="mv-panel-body"><div class="mv-panel-empty">Select a view above</div></div>
          </div>
        </div>
        <div class="mv-panel" data-panel="1">
          <div class="mv-panel-header">
            <select class="mv-panel-select">
              <option value="">Select View...</option>
              <option value="board">Board</option><option value="map">Map</option><option value="write">Writing</option>
              <option value="timeline">Timeline</option><option value="combat">Combat</option><option value="factions">Connections</option>
              <option value="mindmap">Mind Map</option><option value="soundboard">Soundscape</option>
              <option value="dice_log">Dice Log</option><option value="notes">Notes</option>
            </select>
          </div>
          <div class="mv-panel-content">
            <div class="mv-panel-nav hidden"></div>
            <div class="mv-panel-body"><div class="mv-panel-empty">Select a view above</div></div>
          </div>
        </div>
        <div class="mv-panel" data-panel="2">
          <div class="mv-panel-header">
            <select class="mv-panel-select">
              <option value="">Select View...</option>
              <option value="board">Board</option><option value="map">Map</option><option value="write">Writing</option>
              <option value="timeline">Timeline</option><option value="combat">Combat</option><option value="factions">Connections</option>
              <option value="mindmap">Mind Map</option><option value="soundboard">Soundscape</option>
              <option value="dice_log">Dice Log</option><option value="notes">Notes</option>
            </select>
          </div>
          <div class="mv-panel-content">
            <div class="mv-panel-nav hidden"></div>
            <div class="mv-panel-body"><div class="mv-panel-empty">Select a view above</div></div>
          </div>
        </div>
        <div class="mv-panel" data-panel="3">
          <div class="mv-panel-header">
            <select class="mv-panel-select">
              <option value="">Select View...</option>
              <option value="board">Board</option><option value="map">Map</option><option value="write">Writing</option>
              <option value="timeline">Timeline</option><option value="combat">Combat</option><option value="factions">Connections</option>
              <option value="mindmap">Mind Map</option><option value="soundboard">Soundscape</option>
              <option value="dice_log">Dice Log</option><option value="notes">Notes</option>
            </select>
          </div>
          <div class="mv-panel-content">
            <div class="mv-panel-nav hidden"></div>
            <div class="mv-panel-body"><div class="mv-panel-empty">Select a view above</div></div>
          </div>
        </div>
      </div>
    </div>

  </body>
</html>
